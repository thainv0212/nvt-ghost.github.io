<!DOCTYPE html>
<html ⚡>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <title>[Phần 1] Ansible - Khái niệm cơ bản</title>

    <link rel="canonical" href="../index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="GMO-Z.com Vietnam Lab Center Technology Blog" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="[Phần 1] Ansible - Khái niệm cơ bản" />
    <meta property="og:description" content="BÀI TOÁN BAN ĐẦU Đầu tiên, tôi có một bài toán muốn đặt ra như thế này. Tôi có 10 con server cần setup lên thành web server và 3 con server cần setup thành DB server. Nếu setup một cách thủ công thì chúng ta sẽ cần 10 lần" />
    <meta property="og:url" content="https://blog.vietnamlab.vn/phan-1-ansible-khai-niem-co-ban/" />
    <meta property="og:image" content="https://drive.google.com/uc?id&#x3D;1ELOVENDVQZU9Sbws-HTBfDV6mFPRwqP2&amp;export&#x3D;download" />
    <meta property="article:published_time" content="2019-01-04T01:26:14.000Z" />
    <meta property="article:modified_time" content="2019-12-25T02:37:48.000Z" />
    <meta property="article:tag" content="Ansible" />
    <meta property="article:tag" content="playbook" />
    <meta property="article:tag" content="role" />
    <meta property="article:tag" content="module" />
    <meta property="article:tag" content="inventory" />
    <meta property="article:tag" content="blockchain" />
    <meta property="article:tag" content="YAML Manifest" />
    
    <meta property="article:publisher" content="https://www.facebook.com/vietnamlab.vn" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="[Phần 1] Ansible - Khái niệm cơ bản" />
    <meta name="twitter:description" content="BÀI TOÁN BAN ĐẦU Đầu tiên, tôi có một bài toán muốn đặt ra như thế này. Tôi có 10 con server cần setup lên thành web server và 3 con server cần setup thành DB server. Nếu setup một cách thủ công thì chúng ta sẽ cần 10 lần" />
    <meta name="twitter:url" content="https://blog.vietnamlab.vn/phan-1-ansible-khai-niem-co-ban/" />
    <meta name="twitter:image" content="https://drive.google.com/uc?id&#x3D;1ELOVENDVQZU9Sbws-HTBfDV6mFPRwqP2&amp;export&#x3D;download" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="D.T.H.L" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Ansible, playbook, role, module, inventory, blockchain, YAML Manifest" />
    <meta property="og:image:width" content="815" />
    <meta property="og:image:height" content="476" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "GMO-Z.com Vietnam Lab Center Technology Blog",
        "url": "https://blog.vietnamlab.vn/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://blog.vietnamlab.vn/favicon.ico",
            "width": 48,
            "height": 48
        }
    },
    "author": {
        "@type": "Person",
        "name": "D.T.H.L",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/790fde8e108c8f0a98d2f5680c38cc38?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "https://blog.vietnamlab.vn/author/landth/",
        "sameAs": []
    },
    "headline": "[Phần 1] Ansible - Khái niệm cơ bản",
    "url": "https://blog.vietnamlab.vn/phan-1-ansible-khai-niem-co-ban/",
    "datePublished": "2019-01-04T01:26:14.000Z",
    "dateModified": "2019-12-25T02:37:48.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://drive.google.com/uc?id=1ELOVENDVQZU9Sbws-HTBfDV6mFPRwqP2&export=download",
        "width": 815,
        "height": 476
    },
    "keywords": "Ansible, playbook, role, module, inventory, blockchain, YAML Manifest",
    "description": "\n--------------------------------------------------------------------------------\n\nBÀI TOÁN BAN ĐẦU\nĐầu tiên, tôi có một bài toán muốn đặt ra như thế này. Tôi có 10 con server cần\nsetup lên thành web server và 3 con server cần setup thành DB server. Nếu setup\nmột cách thủ công thì chúng ta sẽ cần 10 lần thao tác giống nhau cho việc setup\n10 con web server và với DB server cũng thế. Vậy bài toán đặt ra là có thể gõ 1\nlệnh mà tổng 13 con server tự động được setup không. Câu trả lời là có. Và để\nlà",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.vietnamlab.vn/"
    }
}
    </script>

    <meta name="generator" content="Ghost 3.36" />
    <link rel="alternate" type="application/rss+xml" title="GMO-Z.com Vietnam Lab Center Technology Blog" href="../../rss/index.html" />

    <style amp-custom>
    *,
    *::before,
    *::after {
        box-sizing: border-box;
    }

    html {
        overflow-x: hidden;
        overflow-y: scroll;
        font-size: 62.5%;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    body {
        min-height: 100vh;
        margin: 0;
        padding: 0;
        color: #3a4145;
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        font-size: 1.7rem;
        line-height: 1.55em;
        font-weight: 400;
        font-style: normal;
        background: #fff;
        scroll-behavior: smooth;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    p,
    ul,
    ol,
    li,
    dl,
    dd,
    hr,
    pre,
    form,
    table,
    video,
    figure,
    figcaption,
    blockquote {
        margin: 0;
        padding: 0;
    }

    ul[class],
    ol[class] {
        padding: 0;
        list-style: none;
    }

    img {
        display: block;
        max-width: 100%;
    }

    input,
    button,
    select,
    textarea {
        font: inherit;
        -webkit-appearance: none;
    }

    fieldset {
        margin: 0;
        padding: 0;
        border: 0;
    }

    label {
        display: block;
        font-size: 0.9em;
        font-weight: 700;
    }

    hr {
        position: relative;
        display: block;
        width: 100%;
        height: 1px;
        border: 0;
        border-top: 1px solid currentcolor;
        opacity: 0.1;
    }

    ::selection {
        text-shadow: none;
        background: #cbeafb;
    }

    mark {
        background-color: #fdffb6;
    }

    small {
        font-size: 80%;
    }

    sub,
    sup {
        position: relative;
        font-size: 75%;
        line-height: 0;
        vertical-align: baseline;
    }
    sup {
        top: -0.5em;
    }
    sub {
        bottom: -0.25em;
    }

    ul li + li {
        margin-top: 0.6em;
    }

    a {
        color: #1292EE;
        text-decoration-skip-ink: auto;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        margin: 0;
        font-weight: 700;
        color: #121212;
        line-height: 1.4em;
    }

    h1 {
        font-size: 3.4rem;
        line-height: 1.1em;
    }

    h2 {
        font-size: 2.4rem;
        line-height: 1.2em;
    }

    h3 {
        font-size: 1.8rem;
    }

    h4 {
        font-size: 1.7rem;
    }

    h5 {
        font-size: 1.6rem;
    }

    h6 {
        font-size: 1.6rem;
    }

    amp-img {
        height: 100%;
        width: 100%;
        max-width: 100%;
        max-height: 100%;
    }

    amp-img img {
        object-fit: cover;
    }

    .page-header {
        padding: 50px 5vmin 30px;
        text-align: center;
        font-size: 2rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .page-header a {
        color: #121212;
        font-weight: 700;
        text-decoration: none;
        font-size: 1.6rem;
        letter-spacing: -0.1px;
    }

    .post {
        max-width: 680px;
        margin: 0 auto;
    }

    .post-header {
        margin: 0 5vmin 5vmin;
        text-align: center;
    }

    .post-meta {
        margin: 1rem 0 0 0;
        text-transform: uppercase;
        color: #738a94;
        font-weight: 500;
        font-size: 1.3rem;
    }

    .post-image {
        margin: 0 0 5vmin;
    }

    .post-image img {
        display: block;
        width: 100%;
        height: auto;
    }

    .post-content {
        padding: 0 5vmin;
    }

    .post-content > * + * {
        margin-top: 1.5em;
    }

    .post-content [id]:not(:first-child) {
        margin: 2em 0 0;
    }

    .post-content > [id] + * {
        margin-top: 1rem;
    }

    .post-content [id] + .kg-card,
    .post-content blockquote + .kg-card {
        margin-top: 40px;
    }

    .post-content > ul,
    .post-content > ol,
    .post-content > dl {
        padding-left: 1.9em;
    }

    .post-content hr {
        margin-top: 40px;
    }

    .post .post-content hr + * {
        margin-top: 40px;
    }

    .post-content amp-img {
        background-color: #f8f8f8;
    }

    .post-content blockquote {
        position: relative;
        font-style: italic;
    }

    .post-content blockquote::before {
        content: "";
        position: absolute;
        left: -1.5em;
        top: 0;
        bottom: 0;
        width: 0.3rem;
        background: #000;
    }

    .post-content :not(.kg-card):not([id]) + .kg-card {
        margin-top: 40px;
    }

    .post-content .kg-card + :not(.kg-card) {
        margin-top: 40px;
    }

    .kg-card figcaption {
        padding: 1.5rem 1.5rem 0;
        text-align: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.4em;
        opacity: 0.6;
    }

    .kg-card figcaption strong {
        color: rgba(0,0,0,0.8);
    }

    .post-content :not(pre) code {
        vertical-align: middle;
        padding: 0.15em 0.4em 0.15em;
        border: #e1eaef 1px solid;
        font-weight: 400;
        font-size: 0.9em;
        line-height: 1em;
        color: #dc0050;
        background: #f0f6f9;
        border-radius: 0.25em;
    }

    .post-content > pre {
        overflow: scroll;
        padding: 16px 20px;
        color: #fff;
        background: #1F2428;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0,0,0,.1), 0 0 1px rgba(0,0,0,.4);
    }

    .kg-embed-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    .kg-image-card img {
        margin: auto;
    }

    .kg-gallery-card + .kg-gallery-card {
        margin-top: 0.75em;
    }

    .kg-gallery-container {
        position: relative;
    }

    .kg-gallery-row {
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    .kg-gallery-image {
        width: 100%;
        height: 100%;
    }

    .kg-gallery-row:not(:first-of-type) {
        margin: 0.75em 0 0 0;
    }

    .kg-gallery-image:not(:first-of-type) {
        margin: 0 0 0 0.75em;
    }

    .kg-bookmark-card,
    .kg-bookmark-publisher {
        position: relative;
    }

    .kg-bookmark-container,
    .kg-bookmark-container:hover {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row-reverse;
        color: currentColor;
        background: rgba(255,255,255,0.6);
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        text-decoration: none;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0, 0, 0, 0.1), 0 0 1px rgba(0, 0, 0, 0.4);
        overflow: hidden;
    }

    .kg-bookmark-content {
        flex-basis: 0;
        flex-grow: 999;
        padding: 20px;
        order: 1;
    }

    .kg-bookmark-title {
        font-weight: 600;
        font-size: 1.5rem;
        line-height: 1.3em;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        max-height: 45px;
        margin: 0.5em 0 0 0;
        font-size: 1.4rem;
        line-height: 1.55em;
        overflow: hidden;
        opacity: 0.8;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .kg-bookmark-metadata {
        margin-top: 20px;
    }

    .kg-bookmark-metadata {
        display: flex;
        align-items: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.3em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
    }

    .kg-bookmark-metadata amp-img {
        width: 18px;
        height: 18px;
        max-width: 18px;
        max-height: 18px;
        margin-right: 10px;
    }

    .kg-bookmark-thumbnail {
        display: flex;
        flex-basis: 20rem;
        flex-grow: 1;
        justify-content: flex-end;
    }

    .kg-bookmark-thumbnail amp-img {
        max-height: 200px;
    }

    .kg-bookmark-author {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .kg-bookmark-publisher::before {
        content: "•";
        margin: 0 .5em;
    }

    .kg-width-full.kg-card-hascaption {
        display: grid;
        grid-template-columns: inherit;
    }

    .post-content table {
        border-collapse: collapse;
        width: 100%;
    }

    .post-content th {
        padding: 0.5em 0.8em;
        text-align: left;
        font-size: .75em;
        text-transform: uppercase;
    }

    .post-content td {
        padding: 0.4em 0.7em;
    }

    .post-content tbody tr:nth-child(2n + 1) {
        background-color: rgba(0,0,0,0.1);
        padding: 1px;
    }

    .post-content tbody tr:nth-child(2n + 2) td:last-child {
        box-shadow:
            inset 1px 0 rgba(0,0,0,0.1),
            inset -1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:nth-child(2n + 2) td {
        box-shadow: inset 1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:last-child {
        border-bottom: 1px solid rgba(0,0,0,.1);
    }

    .page-footer {
        padding: 60px 5vmin;
        margin: 60px auto 0;
        text-align: center;
        background-color: #f8f8f8;
    }

    .page-footer h3 {
        margin: 0.5rem 0 0 0;
    }

    .page-footer p {
        max-width: 500px;
        margin: 1rem auto 1.5rem;
        font-size: 1.7rem;
        line-height: 1.5em;
        color: rgba(0,0,0,0.6)
    }

    .powered {
        display: inline-flex;
        align-items: center;
        margin: 30px 0 0;
        padding: 6px 9px 6px 6px;
        border: rgba(0,0,0,0.1) 1px solid;
        font-size: 12px;
        line-height: 12px;
        letter-spacing: -0.2px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        font-weight: 500;
        color: #222;
        text-decoration: none;
        background: #fff;
        border-radius: 6px;
    }

    .powered svg {
        height: 16px;
        width: 16px;
        margin: 0 6px 0 0;
    }

    @media (max-width: 600px) {
        body {
            font-size: 1.6rem;
        }
        h1 {
            font-size: 3rem;
        }

        h2 {
            font-size: 2.2rem;
        }
    }

    @media (max-width: 400px) {
        h1 {
            font-size: 2.6rem;
            line-height: 1.15em;
        }
        h2 {
            font-size: 2rem;
            line-height: 1.2em;
        }
        h3 {
            font-size: 1.7rem;
        }
    }
    </style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="page-header">
        <a href="../../index.html">
                GMO-Z.com Vietnam Lab Center Technology Blog
        </a>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">[Phần 1] Ansible - Khái niệm cơ bản</h1>
                <section class="post-meta">
                    D.T.H.L -
                    <time class="post-date" datetime="2019-01-04">04 Jan 2019</time>
                </section>
            </header>
            <figure class="post-image">
                <amp-img src="https://drive.google.com/uc?id&#x3D;1ELOVENDVQZU9Sbws-HTBfDV6mFPRwqP2&amp;export&#x3D;download" width="600" height="340" layout="responsive"></amp-img>
            </figure>
            <section class="post-content">

                <hr></hr><h2><span><strong>BÀI TOÁN BAN ĐẦU</strong></span></h2>
<span>Đầu tiên, tôi có một bài toán muốn đặt ra như thế này. Tôi có 10 con server cần setup lên thành web server và 3 con server cần setup thành DB server. Nếu setup một cách thủ công thì chúng ta sẽ cần 10 lần thao tác giống nhau cho việc setup 10 con web server và với DB server cũng thế. </span>
<span>Vậy bài toán đặt ra là có thể gõ 1 lệnh mà tổng 13 con server tự động được setup không. Câu trả lời là có. Và để làm được điều thì chúng ta cần đến Ansible.</span>
<h2><strong><span>[[ 1 ]]</span> <span>ANSIBLE LÀ GÌ</span></strong></h2>
<span>Ansible là một platform opensource, nghĩa là bạn có thể viết thêm hay chỉnh sửa tuỳ ý. Ansible khá đơn giản để sử dụng. Nôm na bạn có thể hình dung là chỉ việc khai báo địa chỉ server và những điều muốn làm với server đó vào ansible, rồi sau đó chỉ cần chạy script bạn vừa viết trên và ngồi uống trà chờ hoàn thành.</span>
<h2><strong><span>[[ 2 ]]</span> </strong><span><strong>TẠI SAO NÊN SỬ DỤNG ANSIBLE</strong></span></h2>
<ul>
	<li><span> Ansible miễn phí và là 1 opensource</span></li>
	<li><span> Ansible sử dụng phương thức ssh</span></li>
	<li><span> Việc cài đặt không tốn nhiều tài nguyên</span></li>
	<li><span> Được phát triển bởi ngôn ngữ python. Nên nếu bạn muốn tạo thêm module thì cũng sử dụng bằng python</span></li>
	<li><span> Khá nhẹ và dễ setup</span></li>
	<li><span> Các sciprt thường được dùng định dạng YAML</span></li>
	<li><span> Và Ansible có một cộng đồng tương tác lớn</span></li>
</ul>
<h2><strong><span>[[ 3 ]]</span></strong><span><strong> THÀNH PHẦN TRONG ANSIBLE</strong></span></h2>
<span>Cái này cũng khá nhiều nhưng về cơ bản thì có các phần sau:</span>
<ul>
	<li><span> Playbooks - Là nơi bạn sẽ khai báo kịch bản chạy cho server</span></li>
	<li><span> Tasks - Là những công việc nhỏ trong cuốn sổ Playbooks trên</span></li>
	<li><span> Inventory - Khai báo địa chỉ server cần được setup</span></li>
	<li><span> Modules - Những chức năng hỗ trợ cho việc thực thi tasks dễ và đang dạng</span></li>
	<li><span> v.v…</span></li>
</ul>
<h2><strong><span>[[ 4 ]]</span></strong><strong> LÀM QUEN VỚI YAML</strong></h2>
<span>Chúng ta hãy xem các tập tin YAML là gì. Hầu như tất cả playbooks trong Ansible được viết bằng YAML. Nếu bạn đã quen thuộc với YAML, hãy bỏ qua phần này và chuyển sang phần tiếp theo. Nếu bạn chưa từng làm việc với YAML thì khuyên bạn nên xem phần này kỹ một xíu bởi vì các phần còn lại hầu như phụ thuộc hoàn toàn vào YAML.</span><span>
</span><span>Playbook Ansible được viết theo định dạng cụ thể được gọi là YAML.</span><span>
</span><span>Nếu bạn đã làm việc với các định dạng cấu trúc dữ liệu khác như XML hoặc JSON, bạn sẽ có thể dễ dàng học nó.</span><span>
</span><span>Cũng đừng lo lắng nếu bạn chưa biết gì, vì nó thật sự rất đơn giản. File YAML được dùng để thể hiện dữ liệu. Dưới đây là so sánh nhanh dữ liệu mẫu ở ba định dạng khác nhau.</span><figure class="kg-card kg-image-card"><amp-img src="https://drive.google.com/uc?id=1ZUR3mbaE-NsEkM9fvlnUsUMO52cTRbjt&amp;export=download" class="kg-image" alt width="1210" height="367" layout="responsive"></amp-img></figure><span>Bên trái là dạng XML - hiển thị danh sách các máy chủ và thông tin của chúng. Cùng dữ liệu đó thì hình ở giữa được thể hiện dạng JSON và cuối cùng ở định dạng YAML ở bên phải.</span><br /><br />

<span>Trong YAML có 3 kiểu để biểu diễn giá trị.</span><figure class="kg-card kg-image-card"><amp-img src="https://drive.google.com/uc?id=1nP8Xm22Dg6zg_lcevgG_RT1fhZ9WOtTK&amp;export=download" class="kg-image" alt width="1075" height="313" layout="responsive"></amp-img></figure><span><span>■</span> Key Value Pair (Cặp khoá vs giá trị): </span><br />

<span>Dữ liệu được thể hiện bởi kiểu khoá và giá trị (key và value). Trong YAML, khóa và giá trị được phân tách bằng dấu hai chấm (:). </span><span>Luôn phải có khoảng trắng theo sau dấu hai chấm.</span>
<br /><br />
<span><span>■</span> Mảng trong YAML: </span><br />

<span>Các phần tử trong mảng sẽ được thể hiện bởi dấu gạch ngang ( - ). Cần có khoảng trắng trước mỗi mục. Số lượng khoảng trắng cần bằng nhau trước các phần tử của một mảng. </span><span>Chúng ta hãy xem xét kỹ hơn về các dấu khoảng trắng trong YAML. </span><br />

<span>Ví dụ ở đây ta có một object là Banana. Trong đó có 3 thuộc tính là calories, fat và carbs.</span>
<pre class="language-markup"><code>Banana:
  Calories: 105
  Fat: 0.4 g
  Carbs: 27 g
</code></pre><br />
<span>Lưu ý số lượng khoảng trắng trước mỗi thuộc tính sẽ chỉ ra mối quan hệ cha con. Như ở đây, trước 3 thuộc tính đó có cùng số khoảng trắng, nghĩa là 3 thuộc tính đó nằm trong Banana.</span>

<span>Nhưng điều gì sẽ xảy ra nếu chúng ta có thêm không gian cho fat và carbs. </span>
<pre class="language-markup"><code>Banana:
  Calories: 105
    Fat: 0.4 g
    Carbs: 27 g
</code></pre>
<span>Lúc này fat và crabs sẽ là con của thuộc tính calories và calories là thuộc tính con của Banana.</span>

<span>Vì vậy, số lượng khoảng trắng trong YAML rất quan trọng. Đôi lúc bạn có thể chạy script bị báo lỗi nếu nhầm khoảng trắng với dấu tab.</span><br /><br />

<span><span>■</span> Dạng dict trong YAML: </span><br />

<span>Dạng này chỉ cần biểu diễn khoảng trắng trước các thuộc tính của object. </span><span>Điểm khác biệt của dạng Dict và Array là các thuộc tính liệt kê dạng dict thì không có thứ tự. Trong khi Array thì ngược lại. Nên là ví dụ bạn khai báo như:</span>
<pre class="language-markup"><code>Tasks:
  - install httpd
  - start httpd
</code></pre><br />
<span>Sẽ khác với </span>
<pre class="language-markup"><code>Tasks:
  - start httpd
  - install httpd
</code></pre><br />
<span>Ví dụ trên được viết theo dạng Array, tức ansible sẽ đọc tuần tự từ trên xuống. Như vậy nếu <strong>start httpd</strong> trước khi <strong>install httpd</strong> thì sẽ xảy ra lỗi vì hệ thống không tìm thấy service httpd để start.</span><figure class="kg-card kg-image-card"><amp-img src="https://drive.google.com/uc?id=1fwCbHWZFTLs9Ka05hIt81KXkGFv5GBYE&amp;export=download" class="kg-image" alt width="614" height="406" layout="responsive"></amp-img></figure><h2><strong><span>[[ 5 ]]</span> </strong><span><strong>PLAYBOOKS</strong></span></h2>
<span>Trong playbooks, chúng ta sẽ xác định những gì cần phải làm. Hay nói cách khác là nơi ta sẽ viết kịch bản cho các con server. Playbooks sẽ được viết bằng định dạng YAML. Nên là các bạn cần đảm bảo đọc hiểu được nội dung của cách viết trong YAML nhé.</span>

<span>Trong playbooks sẽ chứa một tập hợn các activities (hoạt động) hay các tasks (nhiệm vụ) sẽ được chạy trên một hay một nhóm servers.</span>

<span>Trong đó task là một hành động duy nhất được thực hiện trên server, ví dụ như cài gói service nào đó, hay bật tắt service.</span>
<br />
<span>Xem thử ví dụ một playbook đơn giản:</span>

 <pre class="language-markup"><code># Simple Ansible Playbook1.yml
-
  name: Play 1
  hosts: localhost
  tasks:
    - name: Execute command "date"
      command: date
    - name: Execute script on server
      script: test_script.sh
    - name: Install httpd service
      yum:
        name: httpd
        state: present
    - name: Start web server
      service:
        name: httpd
        state: started
</code></pre><span>Trên đây là một playbook đơn giản chứa một kịch bản có tên Play 1 (name: Play 1).</span><br />

<span>Kịch bản này sẽ được chạy trên server localhost (hosts: localhost). Nếu bạn muốn thực hiện cùng các nhiệm vụ đó trên nhiều con server thì bạn chỉ cần liệt kê tên server hay tên group server. Khai báo tên server hay group server sẽ nằm trong phần inventory nhé.</span><br />

<span>Có tổng cộng 4 nhiệm vụ cần được chạy cho server. Nhiệm vụ lần lượt là:</span>
<ul>
	<li><span>chạy lệnh date</span></li>
	<li>chạy file test_script.sh</li>
	<li>cài đặt dịch vụ httpd</li>
	<li>start dịch vụ httpd vừa cài trên</li>
</ul>
<span>Các tasks trong playbooks được liệt kê dạng array. Phần trên đã có nói đến, nếu đổi chỗ thứ tự các tasks thì sẽ gây ảnh hưởng không nhỏ nếu những task đó có mối liên quan với nhau. Như ta thấy task thứ 3 và task thứ 4 có mối liên hệ với nhau. Nếu để task start httpd lên trước task install thì sẽ có lỗi xảy ra nếu server hoàn toàn chưa được cài httpd.</span><br /><br />

<span>Bạn để ý các thuộc tính command, script, yum, service là những module có sẵn do ansible cung cấp. Module hỗ trợ bạn viết và thực thi các nhiệm vụ  một cách đơn giản hơn. Nếu muốn tự tạo một module riêng thì ansible vẫn hỗ trợ và cho phép bạn viết module riêng để chạy bằng python. Ngoài những module đơn giản trên, ansible còn cung cấp hằng trăm module khác, bạn có thể tham khảo thêm ở document của ansible.</span><br /><br />

<a href="https://docs.ansible.com/"><span>https://docs.ansible.com/</span></a><br /><br />

<span>Để hiểu rõ hơn module có nhiệm vụ gì, bạn thử nhìn vào task thứ 3 là task cài đặt dịch vụ httpd. Bình thưởng trong linux, muốn cài dịch vụ httpd, bạn phải gõ:</span>
<pre class="language-markup"><code>yum install httpd
</code></pre><br />
<span>Nhưng trong playbook bạn chỉ cần khai báo tên module và tên dịch vụ, module được khai báo tự khắc sẽ nhận lệnh và tự thực thi việc cài gói httpd theo yêu cầu.</span><br />

<span>Cuối cùng, khi bạn đã viết xong một playbook, vậy làm cách nào để chạy nó. Rất đơn giản. Ansible cung cấp cho bạn cú pháp như sau:</span>
<pre class="language-markup"><code>ansible-playbook 
</code></pre><br />
<span>Ví dụ file playbook của bạn tên là my_playbook.yml, bạn sẽ run như sau:</span>
<pre class="language-markup"><code>ansible-playbook my_playbook.yml
</code></pre><br />
<span>Bên cạnh đó nếu bạn cần trợ giúp gì thì dùng lệnh:</span>
<pre class="language-markup"><code>ansible-playbook -help
</code></pre><h2><strong><span>[[ 6 ]]</span> </strong><span><strong>MODULES</strong></span></h2>
<span>Như đã giới thiệu ở phần trên, ansible cung cấp rất nhiều module, không thể trình bày hết các module trong bài viết này, nên mình sẽ giới thiệu một vài module phổ biến thường dùng cho những thao tác đơn giản.</span>
<ul>
	<li><span>System: Bao gồm các module như User, Group, Hostname, Systemd, Service, v.v... </span></li>
	<li>Commands: Thường có module con như Command, Expect, Raw, Script, Shell, v.v...</li>
	<li>Files: Các module làm việc với file như Copy, Find, Lineinfile, Replace, v.v...</li>
	<li>Database: Ansbile cũng support mạnh mẽ những module làm việc với DB như Mongodb, Mssql, Mysql, Postgresql, Proxysql, v.v...</li>
	<li>Cloud: Ansible cũng không quên kết hợp với các dịch vụ clound nổi tiếng như Amazon, Google, Docker, Linode, VMware, Digital Ocean, v.v...</li>
	<li>Windows: Mạnh mẽ với những module như win_copy, win_command, win_domain, win_file, win_shell</li>
</ul>
<span>Và còn hàng trăm module khác đã được ansible cung cấp sẵn.</span><h2><strong><span>[[ 7 ]]</span> INVENTORY</strong></h2>
Đây là nơi sẽ chứa tên các con server hay địa chỉ ip mà bạn muốn thực thi. Nhìn lại file playbook ở trên, thì trong file playbook sẽ có 1 thuộc tính là hosts, đấy chính là nơi khai báo tên server. Bây giờ thử xem file inventory đơn giản:
<pre class="language-markup"><code>#Sample Inventory File
Server1.company.com
Server2.company.com 

[mail]
Server3.company.com 
Server4.company.com 

[db]
Server5.company.com 
Server6.company.com 

[web]
Server7.company.com
Server8.company.com 

[all_servers:children]
mail
db
web
</code></pre><br />
Bạn để ý cách khai báo với [mail], [db], [web]. Đây là cách khai bao 1 group các server với nhau. [mail] là tên group. Trong playbook, nếu bạn muốn file playbook đó sẽ thực thi group các server liên quan đến web, bạn chỉ cần khai báo
<pre class="language-markup"><code>hosts: web
</code></pre><br />
Còn [all_servers:children] là cách khai báo group các group với nhau.<br /><br />

Bên cạnh đó, Ansible còn cung cấp một số params phục vụ cho việc truy cập vào server mà bạn đã khai báo trong inventory file dễ dàng hơn. Cụ thể như server nào đó muốn truy cập vào cần cung cấp user và password, hay server đó không phải là linux mà là window, thì việc login vào cũng có phần khác. Xem ví dụ để hiểu thêm về các params mà ansible đã cung cấp nhé.
<pre class="language-markup"><code>#Sample Inventory file

# Web Servers
web_node1 ansible_host=web01.xyz.com ansible_connection=winrm ansible_user=administrator ansible_password=Win$Pass
web_node2 ansible_host=web02.xyz.com ansible_connection=winrm ansible_user=administrator ansible_password=Win$Pass
 
# DB Servers
sql_db1 ansible_host=sql01.xyz.com ansible_connection=ssh ansible_user=root ansible_ssh_pass=Lin$Pass
sql_db2 ansible_host=sql02.xyz.com ansible_connection=ssh ansible_user=root ansible_ssh_pass=Lin$Pass

</code></pre><br />
Đối với server window, Ansible cung cấp kiểu connect là winrm. Bên cạnh đó cách khai báo password cũng khác với Linux. Ở window sẽ sử dụng param ansible_ssh_pass, còn linux là ansible_password. Các bạn lưu ý điều này nhé.<h2><strong><span>[[ 8 ]]</span> VARIABLES</strong></h2>
<span>Tiếp theo chúng ta sẽ làm quen với biến.</span>

<span>Vậy biến là gì? Cũng giống như các ngôn ngữ lập trình khác, biến được sử dụng để lưu trữ các giá trị và có thể thay đổi giá trị được.</span><br />

<span>Xem ví dụ dưới đây để hiểu rõ cách khai báo biến và sử dụng biến trong ansible như thế nào nhé.</span>
<pre class="language-markup"><code>-
  name: Print car's information
  hosts: localhost
  vars:
    car_model: "BMW M3"
    country_name: USA
    title: "Systems Engineer"
  tasks:
    -
      name: Print my car model
      command: echo "My car's model is {{ car_model }}"

    -
      name: Print my country
      command: echo "I live in the {‌{ country_name }}"
</code></pre><br />
 <span>Để khai báo biến, chúng ta sẽ sử dụng thuộc tính vars mà ansible đã cung cấp.</span><br />
<span>car_model sẽ là key, "BMW M3" sẽ là value. Bên dưới để sử dụng biến car_model ta sử dụng cặp dấu ngoặc nhọn và tên biến {{ car_model }}</span><h2><strong><span>[[ 9 ]]</span> CONDITIONS</strong></h2>
Ansible cũng cho phép bạn điều hướng lệnh chạy hay giới hạn phạm vi để run câu lệnh nào đó. Nói khác đi là nếu điều kiện thoả thì câu lệnh đó mới được thực thi.

Bây giờ ta thử giải một đề bài toán như sau: Nếu tuổi trên 22 thì in ra màn hình là "Tôi đã tốt nghiệp" và ngược lại nếu tuổi dưới 22 thì in là "Tôi chưa tốt nghiệp".

Lúc này chúng ta sẽ sử dụng thuộc tính when mà ansible cung cấp để giới hạn phạm vi chạy của câu lệnh.
<pre class="language-markup">#Simple playbook.yml<code>
-
  name: Toi da tot nghiep chưa
  hosts: localhost
  vars:
    age: 25
  tasks:
    -
      command: echo "Toi chua tot nghiep"
      when: age &lt; 22          
    -                     
      command: echo "Toi da tot nghiep"                     
      when: age &gt;= 22
</code></pre><br />
<span><span>■</span> register</span><br />

Ansible còn cung cấp một thuộc tính khá mạnh mẽ là register. Register giúp nhận kết quả trả về từ một câu lệnh. Sau đó ta có thể dùng kết quá trả về đó cho những câu lệnh chạy sau đó.<br /><br />

Ví dụ ta có bài toán như sau: kiểm tra trạng thái của service httpd, nếu start thất bại thì gửi mail thông báo cho admin.
<pre class="language-markup"><code>#Sample ansible playbook.yml
-
  name: Check status of service and email if its down
  hosts: localhost
  tasks:
    - command: service httpd status
      register: command_output

    - mail:
        to: Admins 
        subject: Service Alert
        body: "Service is down"
      when: command_output.stdout.find("down") != -1
</code></pre><br />
 

Nhờ vào thuộc tính register, kết quả trả về sẽ được chứa vào biến command_output. Từ đó ta sử dụng tiếp các thuộc tính của biến command_output là stdout.find để tìm chữ "down" có xuất hiện trong nội dung trả về không. Nếu không tìm thấy thì kết quả sẽ là -1.<h2><strong><span>[[ 10 ]]</span> LOOPS</strong></h2>
<span>Bạn còn nhớ module yum không. Module yum trong ansible playbook giúp ta cài đặt hay xoá một gói service nào đó. Trong ví dụ ở phần playbook, chúng ta chỉ có cài một gói service. Nhưng nếu server yêu cầu cài thêm nhiều gói service khác như mysql, php thì sao nhĩ. Như bình thường chúng ta sẽ viết như sau:</span>
<pre class="language-markup"><code># Simple Ansible Playbook1.yml
-
  name: Install packages
  hosts: localhost
  tasks:
    - name: Install httpd service
      yum:
        name: httpd
    - name: Install mysql service
      yum:
        name: mysql
    - name: Install php service
      yum:
        name: php
</code></pre><br />
<span>Ở đây mới ví dụ 3 service cần cài mà phải viết lập lại các thuộc tính name, module yum đến 3 lần. Nếu server cần cài lên đến 100 gói service thì việc ngồi copy/paste cũng trở nên vấn đề đấy. Thay vào đó, chúng ta sẽ sử dụng chức năng loops mà ansible đã cung cấp để để viết.</span>
<pre class="language-markup"><code>#Simple Ansible Playbook1.yml
-
  name: Install packages
  hosts: localhost
  tasks:
    - name: Install all service
      yum: name="{{ item }}" state=present
      with_items:
        - httpd
        - mysql
        - php
</code></pre>
 <br />

<span>with_items là một lệnh lặp, thực thi cùng một tác vụ nhiều lần. Mỗi lần chạy, nó lưu giá trị của từng thành phần trong biến item.</span><span>
</span>

 <h2><strong><span>[[ 11 ]]</span> ROLES</strong></h2>
Nếu bạn có nhiều server hay nhiều group server và mỗi server thực thiện những tasks riêng biệt. Và khi này nếu viết tất cả vào cùng một file playbook thì khá là xấu code và khó để quản lý. Ansible đã cung cấp sẵn chức năng roles, về đơn giản nó sẽ giúp bạn phân chia khu vực với nhiệm vụ riêng biệt.<br /><br />

Ví dụ bạn có một kịch bản như bên dưới:
<pre class="language-markup"><code>
#Simple Ansible setup_application.yml
-
  name: Set firewall configurations
  hosts: web
  vars:
    http_port: 8081
    snmp_port: 160-161
    inter_ip_range: 192.0.2.0
    
  tasks:
    - firewalld:
        service: https
        permanent: true
        state: enabled
    - firewalld:
        port: "{{ http_port }}"/tcp
        permanent: true
        state: disabled
    - firewalld:
        port: "{{ snmp_port }}"/udp
        permanent: true
        state: disabled
    - firewalld:
        source: "{{ inter_ip_range }}"/24
        zone: internal
        state: enabled
</code></pre>
<br />Mục tiêu của file playbook setup_application.yml này là cấu hình tường lửa cho group server về web. Bây giờ chúng ta sẽ cắt nhỏ file playbook này ra thành những file có chức năng riêng biệt như file chỉ chưa định nghĩa biến, hay file chứa định nghĩa tasks. Trước khi cắt file playbook nhỏ gọn lại, ta cần tạo cấu trúc thư mục như sau để ansible nhận biết được các thành phần ta đã khai báo.<br />

 <figure class="kg-card kg-image-card"><amp-img src="https://drive.google.com/uc?id=1ps-Vm9BkfdlA_2Thm7TW9nuEDSJPJXx4&amp;export=download" class="kg-image" alt width="1914" height="1102" layout="responsive"></amp-img></figure><h2><span>CUỐI BÀI</span></h2>
Đến đây thì đã xong phần cơ bản khai niệm về ansible. Để đọc hiểu được playbooks file, thì cần phải nắm được các viết script trong file YAML nhé.

            </section>

        </article>
    </main>
    <footer class="page-footer">
        <h3>GMO-Z.com Vietnam Lab Center Technology Blog</h3>
            <p>Blog chia sẻ kỹ thuật của thành viên công ty GMO-Z.com Vietnam Lab Center</p>
        <p><a href="../../index.html">Read more posts →</a></p>
        <a class="powered" href="https://ghost.org" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 156 156"><g fill="none" fill-rule="evenodd"><rect fill="#15212B" width="156" height="156" rx="27"/><g transform="translate(36 36)" fill="#F6F8FA"><path d="M0 71.007A4.004 4.004 0 014 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0130 84H4a4 4 0 01-4-4.007v-8.986zM50 71.007A4.004 4.004 0 0154 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0180 84H54a4 4 0 01-4-4.007v-8.986z"/><rect y="34" width="84" height="17" rx="4"/><path d="M0 4.007A4.007 4.007 0 014.007 0h41.986A4.003 4.003 0 0150 4.007v8.986A4.007 4.007 0 0145.993 17H4.007A4.003 4.003 0 010 12.993V4.007z"/><rect x="67" width="17" height="17" rx="4"/></g></g></svg> Published with Ghost</a>
    </footer>
    
</body>
</html>
