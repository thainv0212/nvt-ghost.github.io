<!DOCTYPE html>
<html ⚡>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <title>Cấu hình môi trường sử dụng Vagrant, Ansible - Step by Step</title>

    <meta name="description" content="Các bạn đã biết về Vagrant, Ansible? 
Nếu là 1 developer, hoặc thậm chí là 1 tester hay designer, chắc hẳn sẽ thích công cụ này." />
    <link rel="canonical" href="../index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="GMO-Z.com Vietnam Lab Center Technology Blog" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Cấu hình môi trường sử dụng Vagrant, Ansible - Step by Step" />
    <meta property="og:description" content="Các bạn đã biết về Vagrant, Ansible? 
Nếu là 1 developer, hoặc thậm chí là 1 tester hay designer, chắc hẳn sẽ thích công cụ này." />
    <meta property="og:url" content="https://blog.vietnamlab.vn/cau-hinh-moi-truong-phat-trien-web-su-dung-vagrant-ansible-step-by-step/" />
    <meta property="og:image" content="https://drive.google.com/uc?id&#x3D;1NCUy-3aVGjoZMnv196fnVYbUbQSfRkNS&amp;export&#x3D;download" />
    <meta property="article:published_time" content="2018-01-24T04:06:00.000Z" />
    <meta property="article:modified_time" content="2018-02-22T11:20:00.000Z" />
    <meta property="article:tag" content="Vagrant" />
    <meta property="article:tag" content="Ansible" />
    <meta property="article:tag" content="cấu hình môi trường" />
    <meta property="article:tag" content="sử dụng ansible nâng cao" />
    
    <meta property="article:publisher" content="https://www.facebook.com/vietnamlab.vn" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Cấu hình môi trường sử dụng Vagrant, Ansible - Step by Step" />
    <meta name="twitter:description" content="Các bạn đã biết về Vagrant, Ansible? 
Nếu là 1 developer, hoặc thậm chí là 1 tester hay designer, chắc hẳn sẽ thích công cụ này." />
    <meta name="twitter:url" content="https://blog.vietnamlab.vn/cau-hinh-moi-truong-phat-trien-web-su-dung-vagrant-ansible-step-by-step/" />
    <meta name="twitter:image" content="https://drive.google.com/uc?id&#x3D;1NCUy-3aVGjoZMnv196fnVYbUbQSfRkNS&amp;export&#x3D;download" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="N.X.P" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Vagrant, Ansible, cấu hình môi trường, sử dụng ansible nâng cao" />
    <meta property="og:image:width" content="1677" />
    <meta property="og:image:height" content="498" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "GMO-Z.com Vietnam Lab Center Technology Blog",
        "url": "https://blog.vietnamlab.vn/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://blog.vietnamlab.vn/favicon.ico",
            "width": 48,
            "height": 48
        }
    },
    "author": {
        "@type": "Person",
        "name": "N.X.P",
        "image": {
            "@type": "ImageObject",
            "url": "https://drive.google.com/uc?id=1ey3d-hkzyw7sUxoxSNSNVlTPDeoVuhCq&export=download",
            "width": 1738,
            "height": 1412
        },
        "url": "https://blog.vietnamlab.vn/author/phongnx/",
        "sameAs": []
    },
    "headline": "Cấu hình môi trường sử dụng Vagrant, Ansible - Step by Step",
    "url": "https://blog.vietnamlab.vn/cau-hinh-moi-truong-phat-trien-web-su-dung-vagrant-ansible-step-by-step/",
    "datePublished": "2018-01-24T04:06:00.000Z",
    "dateModified": "2018-02-22T11:20:00.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://drive.google.com/uc?id=1NCUy-3aVGjoZMnv196fnVYbUbQSfRkNS&export=download",
        "width": 1677,
        "height": 498
    },
    "keywords": "Vagrant, Ansible, cấu hình môi trường, sử dụng ansible nâng cao",
    "description": "Nội dung:\n * Mở đầu\n * Giới thiệu về Vagrant, Ansible\n * Cấu hình môi trường local step by step\n * Cấu hình các server thật\n * Kết luận\n * Tài liệu tham khảo\n\nMở đầu\nTrước hết mình muốn đề cập đến đối tượng đọc bài viết này: Là nhưng bạn đã có\nchút kiến thức về vagrant, ansible, Nếu đã là Master rồi thì không cần đọc cũng\nđược :D. Hoặc là những bạn đang tìm hiểu về công nghệ này, hoặc là bạn đang làm\nviệc với một môi trường đã được thiết lập bởi vagrant, ansible nhưng ai đó đã\nlàm hết những thứ ",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.vietnamlab.vn/"
    }
}
    </script>

    <meta name="generator" content="Ghost 3.36" />
    <link rel="alternate" type="application/rss+xml" title="GMO-Z.com Vietnam Lab Center Technology Blog" href="../../rss/index.html" />

    <style amp-custom>
    *,
    *::before,
    *::after {
        box-sizing: border-box;
    }

    html {
        overflow-x: hidden;
        overflow-y: scroll;
        font-size: 62.5%;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    body {
        min-height: 100vh;
        margin: 0;
        padding: 0;
        color: #3a4145;
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        font-size: 1.7rem;
        line-height: 1.55em;
        font-weight: 400;
        font-style: normal;
        background: #fff;
        scroll-behavior: smooth;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    p,
    ul,
    ol,
    li,
    dl,
    dd,
    hr,
    pre,
    form,
    table,
    video,
    figure,
    figcaption,
    blockquote {
        margin: 0;
        padding: 0;
    }

    ul[class],
    ol[class] {
        padding: 0;
        list-style: none;
    }

    img {
        display: block;
        max-width: 100%;
    }

    input,
    button,
    select,
    textarea {
        font: inherit;
        -webkit-appearance: none;
    }

    fieldset {
        margin: 0;
        padding: 0;
        border: 0;
    }

    label {
        display: block;
        font-size: 0.9em;
        font-weight: 700;
    }

    hr {
        position: relative;
        display: block;
        width: 100%;
        height: 1px;
        border: 0;
        border-top: 1px solid currentcolor;
        opacity: 0.1;
    }

    ::selection {
        text-shadow: none;
        background: #cbeafb;
    }

    mark {
        background-color: #fdffb6;
    }

    small {
        font-size: 80%;
    }

    sub,
    sup {
        position: relative;
        font-size: 75%;
        line-height: 0;
        vertical-align: baseline;
    }
    sup {
        top: -0.5em;
    }
    sub {
        bottom: -0.25em;
    }

    ul li + li {
        margin-top: 0.6em;
    }

    a {
        color: #1292EE;
        text-decoration-skip-ink: auto;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        margin: 0;
        font-weight: 700;
        color: #121212;
        line-height: 1.4em;
    }

    h1 {
        font-size: 3.4rem;
        line-height: 1.1em;
    }

    h2 {
        font-size: 2.4rem;
        line-height: 1.2em;
    }

    h3 {
        font-size: 1.8rem;
    }

    h4 {
        font-size: 1.7rem;
    }

    h5 {
        font-size: 1.6rem;
    }

    h6 {
        font-size: 1.6rem;
    }

    amp-img {
        height: 100%;
        width: 100%;
        max-width: 100%;
        max-height: 100%;
    }

    amp-img img {
        object-fit: cover;
    }

    .page-header {
        padding: 50px 5vmin 30px;
        text-align: center;
        font-size: 2rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .page-header a {
        color: #121212;
        font-weight: 700;
        text-decoration: none;
        font-size: 1.6rem;
        letter-spacing: -0.1px;
    }

    .post {
        max-width: 680px;
        margin: 0 auto;
    }

    .post-header {
        margin: 0 5vmin 5vmin;
        text-align: center;
    }

    .post-meta {
        margin: 1rem 0 0 0;
        text-transform: uppercase;
        color: #738a94;
        font-weight: 500;
        font-size: 1.3rem;
    }

    .post-image {
        margin: 0 0 5vmin;
    }

    .post-image img {
        display: block;
        width: 100%;
        height: auto;
    }

    .post-content {
        padding: 0 5vmin;
    }

    .post-content > * + * {
        margin-top: 1.5em;
    }

    .post-content [id]:not(:first-child) {
        margin: 2em 0 0;
    }

    .post-content > [id] + * {
        margin-top: 1rem;
    }

    .post-content [id] + .kg-card,
    .post-content blockquote + .kg-card {
        margin-top: 40px;
    }

    .post-content > ul,
    .post-content > ol,
    .post-content > dl {
        padding-left: 1.9em;
    }

    .post-content hr {
        margin-top: 40px;
    }

    .post .post-content hr + * {
        margin-top: 40px;
    }

    .post-content amp-img {
        background-color: #f8f8f8;
    }

    .post-content blockquote {
        position: relative;
        font-style: italic;
    }

    .post-content blockquote::before {
        content: "";
        position: absolute;
        left: -1.5em;
        top: 0;
        bottom: 0;
        width: 0.3rem;
        background: #000;
    }

    .post-content :not(.kg-card):not([id]) + .kg-card {
        margin-top: 40px;
    }

    .post-content .kg-card + :not(.kg-card) {
        margin-top: 40px;
    }

    .kg-card figcaption {
        padding: 1.5rem 1.5rem 0;
        text-align: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.4em;
        opacity: 0.6;
    }

    .kg-card figcaption strong {
        color: rgba(0,0,0,0.8);
    }

    .post-content :not(pre) code {
        vertical-align: middle;
        padding: 0.15em 0.4em 0.15em;
        border: #e1eaef 1px solid;
        font-weight: 400;
        font-size: 0.9em;
        line-height: 1em;
        color: #dc0050;
        background: #f0f6f9;
        border-radius: 0.25em;
    }

    .post-content > pre {
        overflow: scroll;
        padding: 16px 20px;
        color: #fff;
        background: #1F2428;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0,0,0,.1), 0 0 1px rgba(0,0,0,.4);
    }

    .kg-embed-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    .kg-image-card img {
        margin: auto;
    }

    .kg-gallery-card + .kg-gallery-card {
        margin-top: 0.75em;
    }

    .kg-gallery-container {
        position: relative;
    }

    .kg-gallery-row {
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    .kg-gallery-image {
        width: 100%;
        height: 100%;
    }

    .kg-gallery-row:not(:first-of-type) {
        margin: 0.75em 0 0 0;
    }

    .kg-gallery-image:not(:first-of-type) {
        margin: 0 0 0 0.75em;
    }

    .kg-bookmark-card,
    .kg-bookmark-publisher {
        position: relative;
    }

    .kg-bookmark-container,
    .kg-bookmark-container:hover {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row-reverse;
        color: currentColor;
        background: rgba(255,255,255,0.6);
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        text-decoration: none;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0, 0, 0, 0.1), 0 0 1px rgba(0, 0, 0, 0.4);
        overflow: hidden;
    }

    .kg-bookmark-content {
        flex-basis: 0;
        flex-grow: 999;
        padding: 20px;
        order: 1;
    }

    .kg-bookmark-title {
        font-weight: 600;
        font-size: 1.5rem;
        line-height: 1.3em;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        max-height: 45px;
        margin: 0.5em 0 0 0;
        font-size: 1.4rem;
        line-height: 1.55em;
        overflow: hidden;
        opacity: 0.8;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .kg-bookmark-metadata {
        margin-top: 20px;
    }

    .kg-bookmark-metadata {
        display: flex;
        align-items: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.3em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
    }

    .kg-bookmark-metadata amp-img {
        width: 18px;
        height: 18px;
        max-width: 18px;
        max-height: 18px;
        margin-right: 10px;
    }

    .kg-bookmark-thumbnail {
        display: flex;
        flex-basis: 20rem;
        flex-grow: 1;
        justify-content: flex-end;
    }

    .kg-bookmark-thumbnail amp-img {
        max-height: 200px;
    }

    .kg-bookmark-author {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .kg-bookmark-publisher::before {
        content: "•";
        margin: 0 .5em;
    }

    .kg-width-full.kg-card-hascaption {
        display: grid;
        grid-template-columns: inherit;
    }

    .post-content table {
        border-collapse: collapse;
        width: 100%;
    }

    .post-content th {
        padding: 0.5em 0.8em;
        text-align: left;
        font-size: .75em;
        text-transform: uppercase;
    }

    .post-content td {
        padding: 0.4em 0.7em;
    }

    .post-content tbody tr:nth-child(2n + 1) {
        background-color: rgba(0,0,0,0.1);
        padding: 1px;
    }

    .post-content tbody tr:nth-child(2n + 2) td:last-child {
        box-shadow:
            inset 1px 0 rgba(0,0,0,0.1),
            inset -1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:nth-child(2n + 2) td {
        box-shadow: inset 1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:last-child {
        border-bottom: 1px solid rgba(0,0,0,.1);
    }

    .page-footer {
        padding: 60px 5vmin;
        margin: 60px auto 0;
        text-align: center;
        background-color: #f8f8f8;
    }

    .page-footer h3 {
        margin: 0.5rem 0 0 0;
    }

    .page-footer p {
        max-width: 500px;
        margin: 1rem auto 1.5rem;
        font-size: 1.7rem;
        line-height: 1.5em;
        color: rgba(0,0,0,0.6)
    }

    .powered {
        display: inline-flex;
        align-items: center;
        margin: 30px 0 0;
        padding: 6px 9px 6px 6px;
        border: rgba(0,0,0,0.1) 1px solid;
        font-size: 12px;
        line-height: 12px;
        letter-spacing: -0.2px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        font-weight: 500;
        color: #222;
        text-decoration: none;
        background: #fff;
        border-radius: 6px;
    }

    .powered svg {
        height: 16px;
        width: 16px;
        margin: 0 6px 0 0;
    }

    @media (max-width: 600px) {
        body {
            font-size: 1.6rem;
        }
        h1 {
            font-size: 3rem;
        }

        h2 {
            font-size: 2.2rem;
        }
    }

    @media (max-width: 400px) {
        h1 {
            font-size: 2.6rem;
            line-height: 1.15em;
        }
        h2 {
            font-size: 2rem;
            line-height: 1.2em;
        }
        h3 {
            font-size: 1.7rem;
        }
    }
    </style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="page-header">
        <a href="../../index.html">
                GMO-Z.com Vietnam Lab Center Technology Blog
        </a>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">Cấu hình môi trường phát triển web sử dụng Vagrant, Ansible - Step by Step</h1>
                <section class="post-meta">
                    N.X.P -
                    <time class="post-date" datetime="2018-01-24">24 Jan 2018</time>
                </section>
            </header>
            <figure class="post-image">
                <amp-img src="https://drive.google.com/uc?id&#x3D;1NCUy-3aVGjoZMnv196fnVYbUbQSfRkNS&amp;export&#x3D;download" width="600" height="340" layout="responsive"></amp-img>
            </figure>
            <section class="post-content">

                <h3>Nội dung:</h3>
<ul>
<li><em>Mở đầu</em></li>
<li><em>Giới thiệu về Vagrant, Ansible</em></li>
<li><em>Cấu hình môi trường local step by step</em></li>
<li><em>Cấu hình các server thật</em></li>
<li><em>Kết luận</em></li>
<li><em>Tài liệu tham khảo</em></li>
</ul>
<h3>Mở đầu</h3>
<p>Trước hết mình muốn đề cập đến đối tượng đọc bài viết này: Là nhưng bạn đã có chút kiến thức về vagrant, ansible, Nếu đã là Master rồi thì không cần đọc cũng được :D. Hoặc là những bạn đang tìm hiểu về công nghệ này, hoặc là bạn đang làm việc với một môi trường đã được thiết lập bởi vagrant, ansible nhưng ai đó đã làm hết những thứ đó cho bạn, bạn chỉ việc xài nó và chưa biết cách để có thể tự cấu hình cho 1 dự án riêng của mình.</p>
<h4>Bài toán</h4>
<p>Ví dụ chúng ta cần thiết lập một môi trường phát triển web, đơn giản mà nói thì cần thiết sẽ có một DB (oracle, mysql .v.v), Ngôn ngữ lập trình web php, java, v.v. Một web server như apache, nginx. Chúng có thể dc cài đặt chung vào 1 máy hoặc phân tách thành các server riêng lẻ để dễ quản lý.</p>
<p>Sau khi các bạn có chút kiến thức về Vagrant và Ansible rồi, chúng ta xem xét bài toán sau:</p>
<p>Đầu tiên chúng ta thiết lập môi trường local theo câu trúc như bên dưới:</p>
<p><amp-img src="https://drive.google.com/uc?id=1c52FG0X5kB4ibPbSpS2GvY_ex9mcTq41&amp;export=download" alt width="1139" height="632" layout="responsive"></amp-img></p>
<p>**CI server: ** Nơi chứa các script để cài đặt môi trường cho các server khác, chứa script deploy source code v.v. Tóm lại CI server là nơi chứa code Ansible playbook, các sự thay đổi về cấu hình, về deploy đều được thực hiện tại đây, rất linh hoạt và nhanh chóng.</p>
<p>**DB: **ở đây chúng ta có cấu trúc Master-Slave, thật ra trong bài viết này mình nói về vấn đề này, các bạn có thể tìm hiểu ở 1 bài viết khác. Ở đây chỉ là 1 ví dụ.</p>
<p>**Web: **Chúng ta sử dụng php, phpfpm và web server Nginx</p>
<p>Sau khi đã cấu hình xong môi trường local, tiếp theo chúng ta sẽ thiết lập môi trường thật (production). Môi trường thật sẽ có kiến trúc như bên dưới:</p>
<p><amp-img src="https://drive.google.com/uc?id=1Fynuq7bpwfR34K0BQjCRMFy93fqnPwHL&amp;export=download" alt width="1279" height="616" layout="responsive"></amp-img></p>
<p>**CI server: ** Không có gì thay đổi với môi trường local, chứa source ansible playbook, được cài đặt git và ansible để chạy command.</p>
<p>**Web: ** Chúng ta sử dụng 2 server, ở đây mô phỏng cho giống thật một chút chứ cũng không đề cập đến vấn đề load banlancer gì hết.</p>
<p>**DB: ** Vẫn kiến trúc như local</p>
<h3>1. Giới thiệu về Vagrant, Ansible</h3>
<p><strong>Vagrant</strong></p>
<p>Các bạn có thể tham khảo các bài viết sau:</p>
<ol>
<li><a href="https://viblo.asia/p/gioi-thieu-ve-vagrant-aRBeXnExvWE" target="_blank">https://viblo.asia/p/gioi-thieu-ve-vagrant-aRBeXnExvWE</a></li>
<li><a href="https://viblo.asia/p/tim-hieu-vagrant-phan-1-1l0rvmDQGyqA" target="_blank">https://viblo.asia/p/tim-hieu-vagrant-phan-1-1l0rvmDQGyqA</a></li>
<li><a href="https://viblo.asia/p/tim-hieu-vagrant-phan-2-vagrant-chef-wznVGLqQvZOe" target="_blank">https://viblo.asia/p/tim-hieu-vagrant-phan-2-vagrant-chef-wznVGLqQvZOe</a></li>
</ol>
<blockquote>
<p>Rõ ràng chúng ta thấy được những điểm mạnh rất lớn của Vagrant, và nếu tiếp tục tìm hiểu thì chúng ta sẽ còn thấy được nhiều hơn. Tuy nhiên dưới góc độ của 1 developer, tôi cho rằng có 1 vấn đề khá lớn đối với Vagrant.</p>
</blockquote>
<blockquote>
<p>Thường thì trong team, leader sẽ đảm nhiệm việc config vagrant từ đầu đến cuối, điều này giúp ích rất nhiều cho members. Tuy nhiên, nếu trong team có nhiều người mới làm quen với công việc, và tiếp tục sử dụng Vagrant, họ sẽ không thể có cơ hội thực hành config server thực tế. Điều này có thể cản trở việc cải thiện khả năng của họ. Do vậy, chúng ta cần sử dụng Vagrant 1 cách linh hoạt kết hợp với nâng cao khả năng của các members trong team.</p>
</blockquote>
<p><strong>Ansible</strong></p>
<ol>
<li><a href="https://viblo.asia/p/phan-1-tim-hieu-ve-ansible-4dbZNxv85YM" target="_blank">https://viblo.asia/p/phan-1-tim-hieu-ve-ansible-4dbZNxv85YM</a></li>
<li><a href="https://tech.vccloud.vn/sys-ops/ansible-phan-2-playbook/" target="_blank">https://tech.vccloud.vn/sys-ops/ansible-phan-2-playbook/</a></li>
</ol>
<h3>2. Cấu hình môi trường local step by step</h3>
<p>Chúng ta bắt đầu tiến hành cấu hình cho local:</p>
<h4>2.1 File Vagrant</h4>
<p>Tạo thư mục Ansible_Example chứa file Vagrantfile với nội dung như sau:</p>
<pre><code>Vagrant.configure(2) do |config|
  config.vm.box = "bento/centos-6.7"
  config.vm.box_url = "https://atlas.hashicorp.com/bento/boxes/centos-6.7"

  server_configs = [
    {"hostname" =&gt; "web",       "ip" =&gt; "192.168.33.31", "port" =&gt; 2221, "memory_size" =&gt; "512"},
    {"hostname" =&gt; "db-master", "ip" =&gt; "192.168.33.32", "port" =&gt; 2222, "memory_size" =&gt; "512"},
    {"hostname" =&gt; "db-slave",  "ip" =&gt; "192.168.33.33", "port" =&gt; 2223, "memory_size" =&gt; "512"},
  ]

  script = "
sudo yum update -y --disablerepo=\* --enablerepo=base,updates ca-certificates
sudo yum install -y epel-release
sudo yum install -y --enablerepo=epel sshpass git
sudo yum install -y --enablerepo=epel-testing ansible
cd ansible-playbook
cp vagrant/insecure_private_key /home/vagrant/.ssh/id_rsa
cp vagrant/ssh_config /home/vagrant/.ssh/config
chmod -R og-rwx /home/vagrant/.ssh
chown -R vagrant.vagrant /home/vagrant/.ssh
cp vagrant/ansible.cfg /etc/ansible/ansible.cfg
#sudo -u vagrant ansible-galaxy --ignore-errors install -p roles -r requirements.yml
"

  config.vm.define :ci do |ci|
    ci.vm.hostname = "ci"
    ci.vm.box = "bento/centos-6.7"
    ci.vm.network :private_network, ip: "192.168.33.30"
    ci.vm.network :forwarded_port, guest: 22, host: 2220, id: "ssh"
    ci.vm.provider "virtualbox" do |v|
      v.customize ["modifyvm", :id, "--memory", "256"]
      v.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
    end
    ci.vm.synced_folder ".", "/home/vagrant/ansible-playbook", owner: "vagrant", group: "vagrant", :create =&gt; true, :mount_options =&gt; ["fmode=700"]
    ci.vm.provision :shell, inline: script
    ci.ssh.private_key_path = "./vagrant/insecure_private_key"
    ci.ssh.insert_key = false
  end

  server_configs.each do |server_config|
    config.vm.define "#{server_config['hostname']}" do |server|
      server.vm.hostname = server_config['hostname']
      server.vm.box = "bento/centos-6.7"
      server.vm.network :private_network, ip: server_config['ip']
      server.vm.network :forwarded_port, guest: 22, host: server_config['port'], id: "ssh"
      server.vm.provider "virtualbox" do |v|
        v.customize ["modifyvm", :id, "--memory", server_config['memory_size']]
        v.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
      end
      server.ssh.private_key_path = "./vagrant/insecure_private_key"
      server.ssh.insert_key = false
    end
  end
end
</code></pre>
<pre><code>Vagrant up
</code></pre>
<p>Kết quả chúng ta có 4 máy ảo centos-6.7.</p>
<p>Nội dung file Vagrantfile cũng khá dễ hiểu, chỉ lưu ý 1 chổ là sau khi vagrant up xong, tại ci server có thể ssh đến bất kỳ server nào thông qua ssh, vì chúng ta đã chuẩn bị sẵn private key và config trong Vagrantfile.</p>
<pre><code>server.ssh.private_key_path = "./vagrant/insecure_private_key"
</code></pre>
<p>Tham khảo config ssh tại:</p>
<p><a href="https://www.vagrantup.com/docs/vagrantfile/ssh_settings.html">https://www.vagrantup.com/docs/vagrantfile/ssh_settings.html</a></p>
<h4>2.2 Chuẩn bị Roles</h4>
<p><a href="http://docs.ansible.com/ansible/latest/playbooks_reuse_roles.html">http://docs.ansible.com/ansible/latest/playbooks_reuse_roles.html</a></p>
<p>Đầu tiên nói về Roles trong  ansible là gì: Có thể hiểu nôm na roles chứa các tác vụ để thực thi một nhiệm vụ cụ thể gì đó, ví dụ như role dùng để cài đặt nginx, role dùng để cài đặt mysl, roles dùng để thực thi một số lệnh cụ thể mà mình có thể tự định nghĩa hoặc tải về từ Ansible Galaxy, github v.v.</p>
<p>Chúng ta chuẩn bị file requirements.yml trong cùng thư mục với Vagrantfile với nọi dung như sau:</p>
<pre><code># ansible-galaxy
- src: geerlingguy.repo-epel
  version: 1.1.2
- src: geerlingguy.repo-remi
  version: 1.2.0
- src: jdauphant.nginx
  version: v2.3.1
- src: geerlingguy.mysql
  version: 2.2.3
- src: geerlingguy.php
  version: 3.2.2
  
# jiken-ansible-role
- src: git+ssh://git@gitlab.example.com:10022/jiken-ansible/ansible-role-libselinux-python.git
  name: jiken.libselinux-python

- src: git+ssh://git@gitlab.example.com:10022/jiken-ansible/ansible-role-ca-certificates.git
  name: jiken.ca-certificates

- src: git+ssh://git@gitlab.example.com:10022/jiken-ansible/ansible-role-ulimit.git
  name: jiken.ulimit

- src: git+ssh://git@gitlab.example.com:10022/jiken-ansible/ansible-role-sysctl.git
  name: jiken.sysctl
</code></pre>
<p>Thực hiện ssh vào server ci</p>
<pre><code>$cd ansible-playbook/
$ansible-galaxy --ignore-errors install -p roles -r requirements.yml
</code></pre>
<p>Sau khi chạy lệnh trên xong, các roles sẽ được tải về.<br />
<amp-img src="https://drive.google.com/uc?id=1s25A5CETtMoWeQEhWNLzmkX8ENm-W99s&amp;export=download" alt width="931" height="592" layout="responsive"></amp-img></p>
<p>Tất nhiên ban đầu, chúng ta chưa xác định được cần thiết sẽ có nhưng role gì (cần setting, cài đặt nhưng gì). Trong quá trình cấu trúc server, mỗi khi cần cài đặt thêm gì thì có thể tải roles có sẵn bằng cách thêm vào file requirements.yml và chạy lệnh trên để tải về, hoặc có thể tự mình viết role. Cách viết roles thế nào thì các bạn google nhé.</p>
<h4>2.3 Cấu hình môi trường cho các server</h4>
<p>Đến đây chúng ta cơ bản đã xong bước chuẩn bị các roles. Tiếp theo chúng ta sẽ đi cấu hình, sử dụng các roles đã có áp vào các server: ci, web, DB_Master, DB_Slave.</p>
<p>Để thực hiện công việc này chúng ta cần 2 file: local.host và file provision.yml có nội dung sau:</p>
<p><strong>local.host</strong></p>
<pre><code>[local_ci]
192.168.33.30

[local_web]
192.168.33.31

[local_db]
192.168.33.32
192.168.33.33


[local:children]
local_ci
local_web
local_db
</code></pre>
<p><strong>provision.yml</strong></p>
<pre><code># local ci
- hosts:
    - local_ci
  connection: local
  remote_user: vagrant
  roles:
    - { role: app.patch-geerlingguy.mysql, tags: ['patch'] }
    - jiken.libselinux-python
    - app.account

# local_web
- hosts:
    - local_web
  remote_user: vagrant
  roles:
    - jiken.libselinux-python
    - jiken.ca-certificates
    - jiken.ulimit
    - jiken.sysctl
    - app.account
    - geerlingguy.repo-epel
    - geerlingguy.repo-remi
    - jdauphant.nginx
    # only for local env because nginx_user is vagrant
    - geerlingguy.php
    - app.pdo_mysql

# local MySQL
- hosts:
    - local_db
  remote_user: vagrant
  roles:
    - jiken.libselinux-python
    - jiken.ca-certificates
    - jiken.ulimit
    - jiken.sysctl
    - app.account
    - geerlingguy.repo-epel
    - geerlingguy.repo-remi 
    - app.mysql-repo
    - geerlingguy.mysql
</code></pre>
<p>File provision.yml rất dễ hiểu phải không. cần cài đặt cái gì cho môi trường nào.</p>
<p>Có thể các bạn cũng có thắc mắc chổ này:</p>
<pre><code>[local:children]
local_ci
local_web
local_db
</code></pre>
<p>Chúng ta có 3 hostname như trên, và mình đặt nó vô 1 group là local, để làm gì? Giải thích 1 chút là các roles này dùng để cấu hình cho các môi trường như local, dev, stg, product v.v. Nếu như muốn không muốn áp dụng 100% các thiết lập của roles thì mình có thể modify một tý cho từng môi trường:</p>
<p>Ví dụ như roles: jdauphant.nginx (role để cài đặt nginx)</p>
<p>Default: chạy cổng 80, root: /usr/share/nginx/html và index page: index.html</p>
<p>Nếu chúng ta cài roles này cho các môi trường, thì các môi trường đều có chung cấu hình default là như vậy, Xong để đối ứng mềm dẻo cho các môi trường cần có các cấu hình khác nhau thì chúng ta phải sửa lại config một tý. Sửa ở đâu? Không sửa trực tiếp trên roles mà định nghĩa ra các file cho  từng môi trường trong folder group_vars.</p>
<p>Ở các bước tiếp theo mình sẽ chỉnh sửa cấu hình cho từng môi trường khác nhau bằng cách tạo ra các file như: all, local, prod .v.v trong thư mục group_vars.</p>
<p>Bây giờ chạy lệnh sau:</p>
<pre><code>$vagrant ssh ci
$cd cd ansible-playbook/
$ansible-playbook -i hosts.local provision.yml --user=vagrant --become
</code></pre>
<p>Quá trình cài đặt sẽ mất chút thời gian.</p>
<p><amp-img src="https://drive.google.com/uc?id=1sQKgyiDPfbyLQvSf3P4HDNOhu5OExuDM&amp;export=download" alt width="1537" height="744" layout="responsive"></amp-img></p>
<h4>2.4 Thay đổi cấu hình môi trường sử dụng group_vars</h4>
<p>Truy cập địa chỉ web: <a href="http://192.168.33.31/">http://192.168.33.31/</a><br />
<amp-img src="https://drive.google.com/uc?id=1c7CUdVpjsN_cA3f8vTSp2BzH_dIyhGn3&amp;export=download" alt width="1752" height="528" layout="responsive"></amp-img></p>
<p>Nginx đã hoạt động, Bây giờ ta thử chỉnh sửa 1 tý cấu hình cho môi trường local, bằng cách tạo file có tên local, all trong thư mục group_vars</p>
<p><strong>group_vars/all</strong></p>
<pre><code>example_gui_deploy_path: /var/www/gmo/example-gui/current

# app.account
system_accounts:
  - { name: example, uid: 12121, group: wheel }

# geerlingguy.mysql
mysql_packages:
  - mysql-community-client-5.7.20-1.el6
  - mysql-community-common-5.7.20-1.el6
  - mysql-community-libs-5.7.20-1.el6
  - mysql-community-libs-compat-5.7.20-1.el6
  - mysql-community-server-5.7.20-1.el6
mysql_root_password: "{{ vault_mysql_root_password }}"
mysql_datadir: "{{ _mysql_datadir }}"
mysql_databases:
  - name: example
    collation: utf8_general_ci
    encoding: utf8
    replicate: 1
mysql_users:
  - name: example
    host: 'localhost'
    password: "{{ mysql_password }}"
    priv: 'example.*:ALL'
  - name: example
    host: '{{ _mysql_allow_hosts }}'
    password: "{{ mysql_password }}"
    priv: 'example.*:ALL'
mysql_server_id: "{{ ansible_play_hosts.index(inventory_hostname) + 1 }}"
mysql_replication_role: "{{ _mysql_replication_role }}"
mysql_replication_master: "{{ _mysql_replication_master }}"
mysql_replication_user: "{{ _mysql_replication_user }}"

# geerlingguy.php
php_packages:
  - php
  - php-fpm
  - php-opcache
  - php-devel
  - php-mbstring
  - php-mcrypt
  - php-pecl-memcached
  - php-phpunit-PHPUnit
  - php-pdo
  - php-gd
php_enablerepo: "remi-php70"
php_date_timezone: "Asia/Tokyo"
php_enable_apc: false
php_enable_webserver: true
php_enable_php_fpm: true
php_fpm_pool_user: "{{ process_execution_user }}"
php_fpm_pool_group: "{{ process_execution_user }}"
php_webserver_daemon: nginx
php_fpm_pm_max_children: 200
php_fpm_pm_start_servers: 20
php_fpm_pm_min_spare_servers: 20
php_fpm_pm_max_spare_servers: 20
</code></pre>
<p><strong>group_vars/local</strong></p>
<pre><code>nginx_sites:
  default:
    - listen 82 default_server
    - server_name _
    - root "/usr/share/nginx/html"
    - set $yii_bootstrap "example.php"
	- index example.php
    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    - location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index  example.php;
        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
      }
vault_mysql_root_password: example!234
vault_mysql_password: example!234

# env variables
execution_env: local

server_name_example: local-id.gmo.jp

process_execution_user: vagrant
ansible_execution_user: vagrant

_ci_server: "{{ groups.local_ci[0] }}"

mysql_user: example
mysql_password: "{{ vault_mysql_password }}"
mysql_port: 3306
mysql_database: example
mysql_hosts: "{{ groups.local_db }}"
_mysql_datadir: /var/lib/mysql
_mysql_allow_hosts: 192.168.33.%
_mysql_replication_master: "{{ mysql_hosts[0] }}"
_mysql_replication_role: "{{ 'master' if ansible_play_hosts.index(inventory_hostname) == 0 else 'slave' }}"
_mysql_replication_user: {
  name: replica,
  host: '{{ _mysql_allow_hosts }}',
  password: "{{ mysql_password }}",
  priv: '*.*:REPLICATION SLAVE',
}
mysql_backup_server: "{{ groups.local_admin[0] }}"
</code></pre>
<p>Như đã nói phía trên, file all giúp ta modify các roles, áp dụng cho tất cả các môi trường. File local chứa những thay đổi chỉ dành cho các server trong group local.</p>
<h4>2.5 Kiểm tra kết nối web server đến mysql</h4>
<p>Tại web server, trong đường dẫn root: /usr/share/nginx/html Tạo file có tên example.php với nội dung sau:</p>
<pre><code>&lt;?php
$servername   = "192.168.33.32";
$database = "example";
$username = "example";
$password = "example!234";

// Create connection
$conn = new mysqli($servername, $username, $password);
// Check connection
if ($conn-&gt;connect_error) {
   die("Connection failed: " . $conn-&gt;connect_error);
}
  echo "Connected successfully";
?&gt;
</code></pre>
<p>Các thông tin kết nối DB như servername, database, username, password đã được định nghĩa trong file modify cấu hình cho local (file group_vars/local).</p>
<p>Khởi động lại ngginx:</p>
<pre><code>$sudo service nginx restart
</code></pre>
<p>Truy cập địa chỉ sau để xem connnect thành công chưa: <a href="http://192.168.33.31:82/example.php">http://192.168.33.31:82/example.php</a></p>
<p><amp-img src="https://drive.google.com/uc?id=19pb6qHwz99R8kXt8jAsAa8SANYnhG9v3&amp;export=download" alt width="785" height="184" layout="responsive"></amp-img></p>
<h3>3. Cấu hình môi trường production</h3>
<p>Vậy đến đây xem như môi trường local chúng ta đã cơ bản hoàn thành, web php đã có thể chạy dc. tiếp theo chúng ta sẽ xem xét đến việc deploy lên môi trường thật gồm nhưng công việc gì.</p>
<ul>
<li><em>1. Cấu hình Private network cho các server</em></li>
<li><em>2. Thiết lập cấu hình network sao cho user bên ngoài chỉ có thể access được đến global ip của web01 và web02, ngoài ra không thể access được vào các server khác, cho dù có mật khẩu root</em></li>
<li><em>3. Cấu hình bảo mật cho các server, từ CI server có thể ssh đến bất kỳ server nào</em></li>
<li><em>4. Tạo file hosts.prod và thêm vào file provision.yml, tiến hành deploy</em></li>
</ul>
<p>Nội dung chi tiết mình sẽ nói trong 1 bài viết khác. (Mấy con server hiện đang được tắt cho đỡ tốn tiền :D)</p>
<h3>4. Kết Luận</h3>
<p><strong>Đạt được:</strong></p>
<p>Bài viết này được viết nhằm tổng hợp và ôn lại kiến thức sau khi đã được một người đàn anh trong dự án training lại, tất nhiên nó còn nhiều điểm thiếu sót, tuy nhiên như đã nhắc đến phía trên về vấn đề sử dụng vagrant và ansible. Thường thì nhưng người có kinh nghiệm như leader sẽ làm nhưng công việc cấu hình môi trường, nên thường những người ít hoặc chưa có kinh nghiệm về cấu hình server sẽ không được đụng đến, điều đó làm mất cơ hội được thử, chưa kể việc thuê VPS hay Cloud mất nhiều chi phí. Vì vậy bài viết mong giúp đỡ nhưng ai mới bắt đầu với vagrant, ansible có cái nhìn tổng quan, có những kiến thức cơ bản để có thể tự mình cấu hình cho các con server dự án riêng của mình. Đầu tiên là local, nếu có điều kiện thì thuê VPS hay Cloud để làm trên đó. Thực tế àm nói, đụng đến mấy con server thật cảm giác nó khác hoàn toàn với local, điều đó làm mình thất rất thích thú.</p>
<p><strong>Chưa đạt được:</strong></p>
<p>Bài viết còn nhiều cái chưa được đề cập đến như:</p>
<ul>
<li><em>Một số hoặt động để đảm bảo an toàn cho các server thật (security)</em></li>
<li><em>Cách viết role như thế nào .vv.</em></li>
<li><em>Cách cấu hình load balance cho web server</em></li>
<li><em>Cách cấu hình DB Master - Slave</em></li>
<li><em>vv.</em></li>
</ul>
<p>Tuy còn thiếu nhiều, xong mục tiêu chính vẫn là muốn người đọc có cái nhìn bao quát, chi tiết thì sẽ tự tìm hiểu học tham khảo những bài viết khác.</p>
<p>Thêm một điều nữa, trong quá trình cấu hình, lỗi xuất hiện thường xuyên và việc đọc lỗi và fix dần dần mất rất nhiều thời gian. Vậy cho thấy được để cấu hình server quả thật không phải điều đơn giản. Tuy vậy chỉ có làm nhiều mới có được nhiều kinh nghiệm mà thôi.</p>
<h3>5. Tài liệu tham khảo </h3>
<ol>
<li><a href="http://docs.ansible.com/ansible/latest/playbooks.html" target="_blank">http://docs.ansible.com/ansible/latest/playbooks.html</a></li>
<li><a href="https://viblo.asia/p/tim-hieu-vagrant-phan-1-1l0rvmDQGyqA" target="_blank">https://viblo.asia/p/tim-hieu-vagrant-phan-1-1l0rvmDQGyqA</a></li>
<li><a href="https://viblo.asia/p/phan-1-tim-hieu-ve-ansible-4dbZNxv85YM" target="_blank">https://viblo.asia/p/phan-1-tim-hieu-ve-ansible-4dbZNxv85YM</a></li>
<li><a href="http://docs.ansible.com/ansible/latest/playbooks_reuse_roles.html" target="_blank">http://docs.ansible.com/ansible/latest/playbooks_reuse_roles.html</a></li>
</ol>


            </section>

        </article>
    </main>
    <footer class="page-footer">
        <h3>GMO-Z.com Vietnam Lab Center Technology Blog</h3>
            <p>Blog chia sẻ kỹ thuật của thành viên công ty GMO-Z.com Vietnam Lab Center</p>
        <p><a href="../../index.html">Read more posts →</a></p>
        <a class="powered" href="https://ghost.org" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 156 156"><g fill="none" fill-rule="evenodd"><rect fill="#15212B" width="156" height="156" rx="27"/><g transform="translate(36 36)" fill="#F6F8FA"><path d="M0 71.007A4.004 4.004 0 014 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0130 84H4a4 4 0 01-4-4.007v-8.986zM50 71.007A4.004 4.004 0 0154 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0180 84H54a4 4 0 01-4-4.007v-8.986z"/><rect y="34" width="84" height="17" rx="4"/><path d="M0 4.007A4.007 4.007 0 014.007 0h41.986A4.003 4.003 0 0150 4.007v8.986A4.007 4.007 0 0145.993 17H4.007A4.003 4.003 0 010 12.993V4.007z"/><rect x="67" width="17" height="17" rx="4"/></g></g></svg> Published with Ghost</a>
    </footer>
    
</body>
</html>
