<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Pipeline CI/CD hoàn chỉnh với Laravel Framework | GMO-Z.com Vietnam Lab Center</title>
    <meta name="description" content="" />
    <meta property="fb:app_id" content="703042457154743" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google-site-verification" content="duCCqsDAWLg3POOfPMr6JiS4R0g0CjouGGM3fhsG0-0" />
    <link rel="shortcut icon" href="../favicon.ico">

    <!-- Stylesheet -->
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.min.css?v=52156bd6b0" />
    <link rel="stylesheet" type="text/css" href="../assets/css/font-awesome.min.css?v=52156bd6b0" />
    <link rel="stylesheet" type="text/css" href="../assets/css/atom-one-dark.min.css?v=52156bd6b0" />
    <link rel="stylesheet" type="text/css" href="../assets/css/screen.css?v=52156bd6b0" />

    <script type="text/javascript" src="../assets/js/libs/jquery.min.js?v=52156bd6b0"></script>

    <link rel="canonical" href="index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="amp/index.html" />
    
    <meta property="og:site_name" content="GMO-Z.com Vietnam Lab Center Technology Blog" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Pipeline CI/CD hoàn chỉnh với Laravel Framework" />
    <meta property="og:description" content="Chuỗi bài về Jenkins  1. Pipeline trong jenkins  2. Hướng dẫn tạo Jenkinsfile  3. Pipeline CI/CD hoàn chỉnh với Laravel Framework  Mục đích cuối cùng của chuỗi bài: xây dựng 1 CI/CD hoàn chỉnh bao gồm:  Docker: sử dụng nền tảng container để triển khai Laravel: framework PHP" />
    <meta property="og:url" content="https://blog.vietnamlab.vn/pipeline-ci-cd-hoan-chinh-voi-laravel-framework/" />
    <meta property="og:image" content="https://drive.google.com/uc?id&#x3D;1u-yF6ILW18gC8dUHg7XJL2aKzDs0hRdR&amp;export&#x3D;download" />
    <meta property="article:published_time" content="2017-12-22T01:00:00.000Z" />
    <meta property="article:modified_time" content="2017-12-22T01:53:34.000Z" />
    <meta property="article:tag" content="Jenkins" />
    <meta property="article:tag" content="CI" />
    <meta property="article:tag" content="CD" />
    <meta property="article:tag" content="laravel" />
    
    <meta property="article:publisher" content="https://www.facebook.com/vietnamlab.vn" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Pipeline CI/CD hoàn chỉnh với Laravel Framework" />
    <meta name="twitter:description" content="Chuỗi bài về Jenkins  1. Pipeline trong jenkins  2. Hướng dẫn tạo Jenkinsfile  3. Pipeline CI/CD hoàn chỉnh với Laravel Framework  Mục đích cuối cùng của chuỗi bài: xây dựng 1 CI/CD hoàn chỉnh bao gồm:  Docker: sử dụng nền tảng container để triển khai Laravel: framework PHP" />
    <meta name="twitter:url" content="https://blog.vietnamlab.vn/pipeline-ci-cd-hoan-chinh-voi-laravel-framework/" />
    <meta name="twitter:image" content="https://drive.google.com/uc?id&#x3D;1u-yF6ILW18gC8dUHg7XJL2aKzDs0hRdR&amp;export&#x3D;download" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="KYO" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Jenkins, CI, CD, laravel" />
    <meta property="og:image:width" content="888" />
    <meta property="og:image:height" content="388" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "GMO-Z.com Vietnam Lab Center Technology Blog",
        "url": "https://blog.vietnamlab.vn/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://blog.vietnamlab.vn/favicon.ico",
            "width": 48,
            "height": 48
        }
    },
    "author": {
        "@type": "Person",
        "name": "KYO",
        "image": {
            "@type": "ImageObject",
            "url": "https://drive.google.com/uc?id=0B05rqFCwNCjkM2hSUERPbEVlSVU&export=download",
            "width": 600,
            "height": 614
        },
        "url": "https://blog.vietnamlab.vn/author/longtv/",
        "sameAs": []
    },
    "headline": "Pipeline CI/CD hoàn chỉnh với Laravel Framework",
    "url": "https://blog.vietnamlab.vn/pipeline-ci-cd-hoan-chinh-voi-laravel-framework/",
    "datePublished": "2017-12-22T01:00:00.000Z",
    "dateModified": "2017-12-22T01:53:34.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://drive.google.com/uc?id=1u-yF6ILW18gC8dUHg7XJL2aKzDs0hRdR&export=download",
        "width": 888,
        "height": 388
    },
    "keywords": "Jenkins, CI, CD, laravel",
    "description": "Chuỗi bài về Jenkins\n\n1. Pipeline trong jenkins\n[https://vietnamlab.vn/blog/2017/11/22/pipeline-voi-jenkins/]\n\n2. Hướng dẫn tạo Jenkinsfile\n[https://vietnamlab.vn/blog/2017/11/22/huong-dan-tao-jenkinsfile/]\n\n3. Pipeline CI/CD hoàn chỉnh với Laravel Framework\n\nMục đích cuối cùng của chuỗi bài: xây dựng 1 CI/CD hoàn chỉnh bao gồm:\n\n * Docker: sử dụng nền tảng container để triển khai\n * Laravel: framework PHP để làm website\n * Unit testing: Unit test cho PHP\n * Feature testing: test chức năng cho s",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.vietnamlab.vn/"
    }
}
    </script>

    <meta name="generator" content="Ghost 3.36" />
    <link rel="alternate" type="application/rss+xml" title="GMO-Z.com Vietnam Lab Center Technology Blog" href="../rss/index.html" />
</head>

<body class="post-template tag-jenkins tag-ci tag-cd tag-laravel nav-closed">
    <script type="text/javascript" src="../assets/js/app/social.js?v=52156bd6b0"></script>
    <div id="fb-root"></div>

    <div id="header">
        <div id="blog-banner">
    <div class="row">
        <div class="col-md-offset-1 col-md-5">
            <img src="../assets/img/vnlab_logo.jpg?v=52156bd6b0" alt="VNLab Logo">
        </div>
        <div class="col-md-5 text-right coworker">
            <img src="../assets/img/vnlab_coworker.jpg?v=52156bd6b0" alt="VNLab coworker">
        </div>
        <div class="col-md-offset-1"></div>
    </div>
</div>

<nav class="navbar navbar-default">
    <div class="row">
        <div class="col-md-offset-1 col-md-10">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                        <li class="">
                            <a class="https://vietnamlab.vn" href="https://vietnamlab.vn">GMO-Z.com Vietnam Lab Center</a>
                        </li>
                        <li class="">
                            <a class="/tag/news/" href="../tag/news/index.html">Tin tức</a>
                        </li>
                        <li class="">
                            <a class="/" href="../index.html">Blog</a>
                        </li>
                        <li class="">
                            <a class="/tuyen-dung/" href="../tuyen-dung/index.html">★ Tuyển dụng ★</a>
                        </li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                        <li><a class="subscribe-button icon-feed" href="../rss/index.html">Đăng ký</a></li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <div class="col-md-offset-1"></div>
        <!-- /.container-fluid -->
    </div>
</nav>

    </div>

    <div id="body" class="row">
        
<div class="col-lg-offset-1 col-lg-7">
        <article class="post tag-jenkins tag-ci tag-cd tag-laravel js-toc-content">
            <div class="post-header">
                <h2 class="post-title"><a href="index.html">Pipeline CI/CD hoàn chỉnh với Laravel Framework</a></h2>
            </div>

            <div class="post-meta">
                <div class="post-date" datetime="2017-12-22">
                    <i class="fa fa-clock-o" aria-hidden="true"></i> 22 December 2017
                </div>
                <div class="post-tag">
                    <i class="fa fa-tags" aria-hidden="true"></i> <a href="../tag/jenkins/index.html">Jenkins</a>, <a href="../tag/ci/index.html">CI</a>, <a href="../tag/cd/index.html">CD</a>, <a href="../tag/laravel/index.html">laravel</a>
                </div>
            </div>

            <div class="post-featured post-featured-single">
                <div class="post-featured-img">
                        <img src="https://drive.google.com/uc?id&#x3D;1u-yF6ILW18gC8dUHg7XJL2aKzDs0hRdR&amp;export&#x3D;download" alt="Pipeline CI/CD hoàn chỉnh với Laravel Framework">
                </div>

                <div class="post-author">
                </div>

                <div class="post-share">
                    <div class="share-button">
                        <div class="fb-share-button" data-href="/pipeline-ci-cd-hoan-chinh-voi-laravel-framework/" data-layout="button" data-size="large" data-mobile-iframe="true">
                        </div>
                    </div>

                    <div class="share-button">
                        <a class="twitter-share-button" data-size="large" href="https://twitter.com/intent/tweet?text=Pipeline%20CI%2FCD%20ho%C3%A0n%20ch%E1%BB%89nh%20v%E1%BB%9Bi%20Laravel%20Framework">
                            Tweet
                        </a>
                    </div>
                </div>
            </div>

            <section class="post-content">
                <!--kg-card-begin: markdown--><p><strong>Chuỗi bài về Jenkins</strong></p>
<p><em>1. <a href="https://vietnamlab.vn/blog/2017/11/22/pipeline-voi-jenkins/">Pipeline trong jenkins</a></em></p>
<p><em>2. <a href="https://vietnamlab.vn/blog/2017/11/22/huong-dan-tao-jenkinsfile/">Hướng dẫn tạo Jenkinsfile</a></em></p>
<p><em><strong>3. Pipeline CI/CD hoàn chỉnh với Laravel Framework</strong></em></p>
<p><strong>Mục đích cuối cùng của chuỗi bài</strong>: xây dựng 1 CI/CD hoàn chỉnh bao gồm:</p>
<ul>
<li>Docker: sử dụng nền tảng container để triển khai</li>
<li>Laravel: framework PHP để làm website</li>
<li>Unit testing: Unit test cho PHP</li>
<li>Feature testing: test chức năng cho service</li>
<li>Deploy: CD deploy container bằng Pipeline</li>
</ul>
<hr>
<h3 id="giithiunhngkeywordtrngyu">Giới thiệu những keyword trọng yếu</h3>
<h4 id="laravel">Laravel</h4>
<p>Ai làm PHP thì đều biết về Laravel, framework PHP phổ biến và mạnh mẽ nhất hiện nay. Laravel tích hợp nhiều kỹ thuật vào giúp cho phát triển những ứng dụng trở nên dễ dàng hơn đối với developer. Điển hình:<br>
*</p>
<p>Ngoài ra với cộng đồng những nhà phát triển lớn và hoạt động tích cực thì cũng có vô vàn các package hỗ trợ thêm nhiều tính năng cho Laravel khiến cho framework này ngày càng có nhiều người sử dụng.</p>
<p><img src="https://i2.wp.com/zenofcoding.com/wp-content/uploads/2017/02/php_mvc_frameworks_2017.png?w=1760" alt=""><br>
<em>Laravel vượt mặt các PHP Framework đình đám vào giữa năm 2013 và vẫn trở nên phổ biến rộng rãi hơn</em></p>
<p><strong>Testing trong Laravel :</strong> các bạn có thể tham khảo thêm tại <a href="https://laravel.com/docs/5.5/testing">đây</a></p>
<ul>
<li><strong>Unit testing :</strong> thư mục chứa code Unit test của Laravel là <code>&lt;project_root_path&gt;/tests/Unit</code> ở đây ta khai báo các class mới extended từ class <code>TestCase</code> để viết code unit test cho project. Sử dụng <code>$this-&gt;assertXXX()</code> để kiểm tra output của các module cần test. Ví dụ</li>
</ul>
<pre><code>    public function testExample()
    {
        $this-&gt;assertEquals(true, Tools::compare(1,1)); // test kết quả trả về của Tools::compare(1,1) là true
    }
</code></pre>
<ul>
<li><strong>Feature testing :</strong> thư mục chứa code Unit test của Laravel là <code>&lt;project_root_path&gt;/tests/Feature</code> ở đây ta khai báo các class mới extended từ class <code>TestCase</code> để viết code unit test cho project. các method so sánh kiểm tra chức năng sẽ được call từ object <code>\Illuminate\Foundation\Testing\TestResponse</code> mỗi lần ta thực hiện 1 request. Ví dụ:</li>
</ul>
<pre><code>  public function testAddPostTitleInvalid()
  {
    $title = 'Post's title';
    $content = 'Post's content';
    $user = User::all()-&gt;first(); // lấy user đầu tiên trong db để xác thực

    $this-&gt;actingAs($user)
      -&gt;get(route('post.add')); // mở url add post với user vừa lấy từ db

    $response = $this-&gt;followingRedirects() 
      -&gt;post(route('post.confirm'), [
        'title'   =&gt; $title,
        'content' =&gt; $content,
        '_token'  =&gt; csrf_token(),
      ]); // gửi post request lên server, follow theo page khi bị redirect

    $response-&gt;assertSeeText('The title must be at least 10 characters'); // Kiểm tra có lỗi cảnh báo title phải có ít nhất 10 ký tự
  }
</code></pre>
<h4 id="docker">Docker</h4>
<p>Một thuật ngữ quá hot trong giới DevOps trong khoảng 4 năm trở lại đây, Docker ứng dụng công nghệ container hoá, đóng gói service vào container nhẹ và nhanh. Docker đã thay đổi tư duy về hệ thống từ kiến trúc phần mềm tổ chức bằng các server, máy ảo chuyển hoá sang tổ chức bằng container, Docker giúp cho quá trình phát triển cũng như vận hành các hệ thống trở nên nhanh và hiệu quả hơn bao giờ hết. Jenkins cũng bắt kịp theo xu hướng và đã hỗ trợ rất nhiều cho Docker, vì vậy bài viết này sẽ hướng dẫn cách thiết lập CI/CD cho Laravel trên nền tảng Docker.</p>
<p><img src="https://www.docker.com/sites/default/files/Package%20software.png" alt=""></p>
<p><strong>Docker compose</strong>: là 1 trong 3 công cụ <strong>orchestration</strong> (điều phối cụm container, docker daemon), ngoài compose ra còn có Docker machine và Docker swarm, Docker compose là công cụ quản lý tập trung nhiều container trên 1 file meta là file <strong>docker-compose.yml</strong>, file này sẽ định nghĩa mọi thiết lập về các container để tất cả có thể phối hợp với nhau tạo hành 1 service hoàn chỉnh. Bài viết này sử dụng Docker compose để xây dựng 1 web service hoàn chỉnh (bao gồm Nginx + PHP-Fpm + MySQL)</p>
<p><img src="https://foxutech.com/wp-content/uploads/2017/06/docker-compose1.png" alt=""></p>
<h3 id="biton">Bài toán</h3>
<p>Các yêu cầu của bài toán đặt ra như sau:</p>
<ul>
<li>Ta có 1 web service:
<ul>
<li>Được viết bằng framework Laravel</li>
<li>Web service này có 2 loại automation test là Unit test và Feature test (Integration test)</li>
</ul>
</li>
<li>Tất cả thành phần về infrastructure của web service đều được xây dựng trên nền tảng Docker</li>
<li>Yêu cầu đặt ra: mỗi commit lên repo của project web service này đều sẽ thực hiện những công việc sau:
<ol>
<li>Build lại những image được sử dụng trong hệ thống</li>
<li>Chạy Unit test trên container chứa source code PHP của service</li>
<li>Unit test ok thì sẽ deploy lại web service sử dụng Docker compose</li>
<li>Sau khi deloy xong thì sẽ chạy Feature test để kiểm tra các chức năng của hệ thống đã hoạt động đúng đắn chưa.</li>
</ol>
</li>
</ul>
<p><em><strong>Hình mô phỏng</strong></em><br>
<img src="https://drive.google.com/uc?id=1_GSldOZn0aYQnHTMsmlWS9cnH7FllAhg&amp;export=download" alt=""></p>
<hr>
<h3 id="trinkhai">Triển khai</h3>
<p>Công việc chính sẽ có 2 giai đoạn sau:</p>
<ul>
<li><strong>Thiết kế container :</strong> Build hoặc lựa chọn các image cần thiết để xây dựng nên service hoàn chỉnh + thiết lập file <code>docker-compose.yml</code> để quản lý các container.</li>
<li><strong>Thiết lập Pipeline trên Jenkins :</strong> Tạo file Jenkinsfile để định nghĩa các stage cho mô hình CI/CD bao gồm: build image, chạy Unit testing, Deploy, chạy Feature tesing.</li>
</ul>
<h4 id="thitkcontainer">Thiết kế container</h4>
<p>Bố cục container như sau:</p>
<ol>
<li>Container web service: là container chạy nginx để xử lý các HTTP request</li>
<li>Container PHP-FPM: là container chạy PHP-FPM để chạy các PHP script tương ứng với request HTTP từ Nginx đẩy qua.</li>
<li>Container MySQL: chạy MySQL</li>
</ol>
<blockquote>
<p><strong>※Chú ý:</strong> Các bạn chưa quen vs Docker có thể đặt câu hỏi là tại sao lại tách Nginx và PHP-FPM ra? -&gt; bạn có thể cho Nginx và PHP-FPM chung 1 container, tuy nhiên tư tưởng của Docker là container ko phải là Virtual Machine, mà nó tương đương với 1 service vì vậy tách Nginx và PHP-FPM ra 2 container ta cũng hiểu như là 2 service thôi, hơn nữa việc tách ra như vậy cho ta một số lợi điểm như là:</p>
</blockquote>
<blockquote>
<ul>
<li><em>quản lý container dễ dàng hơn, log của Nginx và PHP-FPM không bị lẫn lộn vào nhau.</em></li>
</ul>
</blockquote>
<ul>
<li><em>Scale Nginx và PHP-FPM là độc lập -&gt; tiết kiệm tài nguyên và giúp sacle linh hoạt hơn.</em></li>
</ul>
<p><strong>1. Container web service</strong>: ta sử dụng image <code>nginx:latest</code> (latest là tag của image, ý là sử dụng version mới nhất) để build lại image Nginx mới với config mới phù hợp với service của ta. File <code>Dockerfile</code> có nội dung như dưới đây (giải thích sẽ được comment ngay trong <code>Dockerfile</code>)</p>
<pre><code>FROM nginx:latest

ADD ./default.conf /etc/nginx/conf.d/default.conf # config server web

ADD ./src /var/www/blog # copy source code của service vào image
RUN chown www-data:www-data -R /var/www/blog # đổi sở hữu của thư mục web thành user www-data

RUN apt-get update # update package [Option]
RUN apt-get install net-tools -y # cài đặt một số tools để quản lý network [Option]
</code></pre>
<p>Nội dung của file <code>default.conf</code> như dưới đây:</p>
<pre><code>server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name localhost;

    index index.php index.html;
    error_log  /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
    root /var/www/blog/public;

    location / {
        index index.php index.html index.htm;
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass web:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }
}
</code></pre>
<p>Trong file <code>default.conf</code> thì quan trọng nhất là phần config cho xử lý từ URL của HTTP request gọi đến PHP-FPM để chạy script PHP tương ứng. Trong đó <code>fastcgi_pass web:9000;</code> các bạn hãy chú ý config này, thông thường khi Nginx và PHP-FPM cài chung trên 1 host (không sử dụng Docker) thì việc giao tiếp giữa Nginx và PHP-FPM hay sử dụng socket (<code>fastcgi_pass  unix:/var/run/php-fpm/marketplace.sock;</code>) còn khi ta tách Nginx và PHP-FPM ra 2 container thì ta sử dụng kiểu tương tác là TCP/IP.<br>
Build image thì ta sử dụng command <code>docker build -f &lt;Dockerfile path&gt; . -t &lt;tag_name&gt;</code></p>
<p><strong>2. Container PHP-FPM :</strong> Ta sử dụng base image là <code>php:7-fpm</code> (PHP 7), Dockerfile sẽ có nội dụng như dưới đây (giải thích sẽ được comment ngay trong <code>Dockerfile</code>):</p>
<pre><code>FROM php:7-fpm

RUN apt-get update &amp;&amp; apt-get install -y libmcrypt-dev mysql-client \
    &amp;&amp; docker-php-ext-install mcrypt pdo_mysql # cài một số package cần thiết

ADD ./php.conf /usr/local/etc/php-fpm.conf # Config PHP
COPY ./php.ini /usr/local/etc/php/ # Config PHP

ADD ./src /var/www/blog # Add source code của service vào image
RUN chown www-data:www-data -R /var/www/blog # đổi sở hữu của thư mục web thành user www-data

RUN apt-get install net-tools -y # cài đặt một số tools để quản lý network [Option]

WORKDIR /var/www/blog # khai báo path của work directory ( mọi tương tác vs container sẽ bắt đầu từ đây)
</code></pre>
<p>Nội dung những file config của PHP bạn có thể xem tại <a href="https://github.com/kyo88/laravel-5v5-blog">link</a></p>
<p><strong>3. Container MySQL :</strong> sử dụng image <code>mysql:5.6</code></p>
<p><strong>4. Xây dựng file <code>docker-compose.yml</code></strong>: trong file <code>docker-compose.yml</code> ta thiết lập cho các container bao gồm những việc như là:</p>
<ul>
<li>Port mapping: public những port nào trong container ra ngoài</li>
<li>Thiết lập network giữa các container</li>
<li>Khai báo các biến môi trường truyền vào cho container</li>
<li>Thiết lập resource cho container</li>
<li>...</li>
</ul>
<p>Dockerfile có nội dung như sau:</p>
<pre><code>version: '3'
services:
    nginx:
        image: kyo88kyo/nginx
        ports:
            - &quot;9999:80&quot;
        networks:
            - mynet
        links:
            - web
        deploy:
            placement:
                constraints: [node.role == manager]
    web:
        image: kyo88kyo/blog
        environment:
            - &quot;DB_PORT=3306&quot;
            - &quot;DB_HOST=database&quot;
        networks:
            - mynet
        deploy:
            mode: replicated
            replicas: 4
            placement:
                constraints: [node.role == worker]
            resources:
                limits:
                    cpus: '0.1'
                    memory: 256M
    database:
        image: mysql:5.6
        environment:
            - &quot;MYSQL_ROOT_PASSWORD=Calldb@123456&quot;
            - &quot;MYSQL_USER=blog&quot;
            - &quot;MYSQL_PASSWORD=Blog@123456&quot;
            - &quot;MYSQL_DATABASE=kyo&quot;
        ports:
            - &quot;33061:3306&quot;
        networks:
            - mynet
        deploy:
            mode: replicated
            replicas: 1
            placement:
                constraints: [node.role == worker]

networks:
    mynet:
</code></pre>
<p>Để test thử ta sử dụng lệnh <code>docker-compose up</code> thì sẽ thấy có 3 container được tạo ra:<br>
<img src="https://drive.google.com/uc?id=1pUqCqDFTHkVOYsEt3A6k4dBFoG4igycN&amp;export=download" alt=""><br>
<strong>Do các image sử dụng trong <code>docker-compose.yml</code> đều đã được mình public trên <a href="https://hub.docker.com/">docker hub</a> nên chỉ cần bạn sử dụng file <code>docker-compose.yml</code> trên và up nó lên thì sẽ truy cập vào web service được</strong></p>
<p>Access vào port 9999 (mapping từ container nginx ra) ta sẽ thấy truy cập được vào web service<br>
<img src="https://drive.google.com/uc?id=1H9EO95jegVGR8Q4LrdKQvNImDmKL0RWw&amp;export=download" alt=""></p>
<p>Ok vậy là việc thiết lập docker đã xong 99% rồi. Giờ ta thiết lập Pipeline cho web service thôi!!!</p>
<h4 id="thitlppipelinetrnjenkins">Thiết lập Pipeline trên Jenkins</h4>
<p>Các bước thiết lập:</p>
<ul>
<li>Trên web Jenkins tạo item type là <strong>Multibranch Pipeline</strong> (mới trigger git push được) và thiết lập git như ảnh dưới ( cần phải fork project <a href="https://github.com/kyo88/laravel-5v5-blog">laravel-5v5-blog</a> của mình về acc github của bạn )<br>
<img src="https://drive.google.com/uc?id=1651D9D_sqlytFAjIGG47tD3kuzx_LyrC&amp;export=download" alt=""></li>
<li>Trong project <a href="https://github.com/kyo88/laravel-5v5-blog">laravel-5v5-blog</a> có sẵn file Jenkinfile với thiết lập như dưới đây</li>
</ul>
<pre><code>node ('slave'){ // run trên node có label là slave
    checkout scm

    stage('Build') {
        checkout scm
        sh 'pwd &amp;&amp; cd src &amp;&amp; /usr/local/bin/composer install'
        docker.build(&quot;kyo88kyo/nginx&quot;, &quot;-f Dockerfile-nginx .&quot;)
        docker.build(&quot;kyo88kyo/blog&quot;)
    }

    stage('Test') {
        docker.image('kyo88kyo/blog').inside {
            sh 'php --version'
            sh 'cd /var/www/blog &amp;&amp; ./vendor/bin/phpunit --testsuite Unit'
        }
    }

    stage('Deploy') {
        sh 'cd src &amp;&amp; /usr/local/bin/docker-compose down'
        sh 'cd src &amp;&amp; /usr/local/bin/docker-compose up -d'
        sh 'sleep 10 &amp;&amp; cd src &amp;&amp; /usr/local/bin/docker-compose run web php artisan migrate'
    }

    stage ('Test Feature') {
        sh 'cd src &amp;&amp; /usr/local/bin/docker-compose run web ./vendor/bin/phpunit --testsuite Feature'
    }
}
</code></pre>
<p>Giải thích các stage:<br>
* <strong>Build :</strong> build lại 2 image là <code>kyo88kyo/nginx</code> và <code>kyo88kyo/blog</code><br>
* <strong>Test Unit :</strong> chạy unit testing ngay bên trong docker container tạo ra từ image <code>kyo88kyo/blog</code> (container tạo ra rồi bị xóa luôn lúc chạy xong)<br>
* <strong>Deploy :</strong> dùng docker compose deploy toàn bộ web service ( xóa tất cả container cũ rồi tạo mới lại, đây chỉ làm trên môi trường test thôi còn thực tế trên production sẽ ko làm vậy vì sẽ mất hết database, ta cũng có thể mount volume chứa data vào cho container MySQL thì sẽ ko bị mất dữ liệu)<br>
* <strong>Test Feature :</strong> chạy feature testing trên container PHP đã deploy</p>
<h4 id="demo">Demo</h4>
<p>Nội dung:</p>
<ol>
<li>Add thêm 1 dòng text với nội dung <strong>&quot; Test webhook&quot;</strong> vào homepage của web service</li>
<li>Push commit thay đổi trên lên github repo</li>
<li>Kiểm tra trên Jenkins để xem Jenkins trigger tự động từ github và chạy lại pipeline của project</li>
<li>Sau khi build trên Jenkins chạy xong ta reload lại url của web service để xem thay đổi, xem dòng text <strong>&quot; Test webhook&quot;</strong> hiển thị trên homepage.</li>
</ol>
<p>Mời các bạn xem ảnh gif sau để xem lại quá trình demo trên<br>
<img src="https://image.ibb.co/igLAQR/jenkins_pipeline_docker2.gif" alt=""></p>
<h3 id="ktlun">Kết luận</h3>
<ul>
<li>Bài viết này là bài viết cuối cùng trong serial bài về Jenkins, hy vọng các bạn đã nắm rõ được cách thiết lập Pipeline trong Jenkins và hình dung được quá trình CI/CD với Docker cho Laravel framework hoạt động như thế nào.</li>
<li>Mọi thắc mắc xin để comment trong post này hoặc liên hệ skype <code>longkyo1988</code> để hỏi nhé.</li>
</ul>
<h5 id="linkthamkho">Link tham khảo</h5>
<ul>
<li><a href="https://docs.docker.com/compose/">Docker composer</a></li>
<li><a href="https://laravel.com/docs/5.5/testing">Laravel Testing</a></li>
</ul>
<!--kg-card-end: markdown-->
            </section>

            <div class="post-footer">
                <div class="share-button">
                    <div class="fb-share-button" data-href="/pipeline-ci-cd-hoan-chinh-voi-laravel-framework/" data-layout="button_count" data-size="large" data-mobile-iframe="true">
                    </div>
                </div>

                <div class="share-button">
                    <a class="twitter-share-button" data-size="large" href="https://twitter.com/intent/tweet?text=Pipeline%20CI%2FCD%20ho%C3%A0n%20ch%E1%BB%89nh%20v%E1%BB%9Bi%20Laravel%20Framework">
                        Tweet
                    </a>
                </div>

                <div class="share-button">
                    <div class="g-plusone" data-href="/pipeline-ci-cd-hoan-chinh-voi-laravel-framework/"></div>
                </div>
            </div>
            <div id="widget-for-reem-10-1"></div><script src="https://reem.vn/reem.js?m=10"></script>
        </article>


        <div class="post-comments">
            <div class="fb-comments" data-href="https://blog.vietnamlab.vn/pipeline-ci-cd-hoan-chinh-voi-laravel-framework/" data-numposts="10" data-order-by="reverse_time" data-width="100%"></div>
        </div>
</div>
<div class="col-lg-3">
    <div id="sidebar">

    <gcse:search></gcse:search>

    <div class='sidebar-box'>
        <div id="widget-for-reem-4-1"></div><script src="https://163.44.192.76/rem.js?m=4"></script>
    </div>
    <div class="sidebar-box">
        <div class="sidebar-title h2">Tuyển dụng</div>
        <div class="sidebar-content">
          <a class="title" href="https://blog.vietnamlab.vn/tuyen-dung">
            <img
              style="max-width: 100%"
              src="https://drive.google.com/uc?id=1aYKdTvr-4CYterc6pPPBYoFezghrkGZf"
              alt="Tuyển dụng">
          </a>
        </div>
    </div>

    <div class="sidebar-box">
        <div class="sidebar-title h2">Facebook</div>
        <div class="sidebar-content">
            <div class="fb-page" data-href="https://www.facebook.com/vietnamlab.vn" data-small-header="false" data-adapt-container-width="true" data-hide-cover="false" data-width="500" data-show-facepile="true">
                <blockquote cite="https://www.facebook.com/vietnamlab.vn" class="fb-xfbml-parse-ignore">
                    <a href="https://www.facebook.com/vietnamlab.vn">GMO-Z.com Vietnam Lab Center</a>
                </blockquote>
            </div>
        </div>
    </div>

    <div class="sidebar-box">
        <div class="sidebar-title h2">Mục lục</div>
        <div class="sidebar-content js-toc"></div>
    </div>

    
    <div class="sidebar-box">
        <div class="sidebar-title h2">Tin tức</div>
        <div class="sidebar-content">
                    <div class="media">
                        <div class="media-left">
                            <a href="../bao-cao-nghien-cuu-quy-3/index.html">
                                    <img style="object-fit: cover" class="media-object" src="../content/images/1CSKMZA-hwBOtsfRK0JjjcNZUrF80lGLt.PNG" width="50" height="50" alt="Báo cáo nghiên cứu quý 3 năm 2020">
                            </a>
                        </div>
                        <div class="media-body">
                            <a class="title" href="../bao-cao-nghien-cuu-quy-3/index.html">Báo cáo nghiên cứu quý 3 năm 2020</a>
                            <span>, 30 October 2020</span>
                        </div>
                    </div>
                    <div class="media">
                        <div class="media-left">
                            <a href="../untitled-9/index.html">
                                    <img style="object-fit: cover" class="media-object" src="https://drive.google.com/uc?id&#x3D;19caFAeGojP08PERt9NhyH-tZln5o1dyt&amp;export&#x3D;download" width="50" height="50" alt="Rộn ràng đón tết trung thu 2020">
                            </a>
                        </div>
                        <div class="media-body">
                            <a class="title" href="../untitled-9/index.html">Rộn ràng đón tết trung thu 2020</a>
                            <span>, 25 September 2020</span>
                        </div>
                    </div>
                    <div class="media">
                        <div class="media-left">
                            <a href="../truyen-thong-hoc-tieng-nhat/index.html">
                                    <img style="object-fit: cover" class="media-object" src="https://drive.google.com/uc?id&#x3D;19mB9PZcsjUoxU5mbNYE49Ai0dMUlOPt8&amp;export&#x3D;download" width="50" height="50" alt="Truyền Thống học tiếng Nhật tại VNLAB.">
                            </a>
                        </div>
                        <div class="media-body">
                            <a class="title" href="../truyen-thong-hoc-tieng-nhat/index.html">Truyền Thống học tiếng Nhật tại VNLAB.</a>
                            <span>, 14 August 2020</span>
                        </div>
                    </div>
                    <div class="media">
                        <div class="media-left">
                            <a href="../team-building-vuon-quoc-gia-ba-vi-2020/index.html">
                                    <img style="object-fit: cover" class="media-object" src="https://drive.google.com/uc?id&#x3D;1vCDL4ACVJLRYbc_bMUF-XtOkBYCmlvFL&amp;export&#x3D;download" width="50" height="50" alt="Team Building Vườn Quốc Gia Ba Vì 2020">
                            </a>
                        </div>
                        <div class="media-body">
                            <a class="title" href="../team-building-vuon-quoc-gia-ba-vi-2020/index.html">Team Building Vườn Quốc Gia Ba Vì 2020</a>
                            <span>, 30 June 2020</span>
                        </div>
                    </div>
                    <div class="media">
                        <div class="media-left">
                            <a href="../bao-cao-nghien-cuu-quy-1-nam-2020/index.html">
                                    <img style="object-fit: cover" class="media-object" src="https://drive.google.com/uc?id&#x3D;13zVnT-6TUc6EkCcZox_nn2PHeBSxihYm&amp;export&#x3D;download" width="50" height="50" alt="Báo cáo nghiên cứu Quý 1 năm 2020">
                            </a>
                        </div>
                        <div class="media-body">
                            <a class="title" href="../bao-cao-nghien-cuu-quy-1-nam-2020/index.html">Báo cáo nghiên cứu Quý 1 năm 2020</a>
                            <span>, 20 April 2020</span>
                        </div>
                    </div>
        </div>
    </div>

    <div class="sidebar-box">
        <div class="sidebar-title h2">Key words</div>
        <div class="sidebar-content">
                    <span class="label label-default text-justify tag">
                        <a href="../tag/%2508google-apps-script/index.html" title="google apps script" class="tag tag-5c2c443cc00d970001d28829 google-apps-script">google apps script</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="https://blog.vietnamlab.vn/404/" title="#api" class="tag tag-5e813cddf7370d0001b812c4 hash-api">#api</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="https://blog.vietnamlab.vn/404/" title="#drakov" class="tag tag-5ad30b8d83719800014583ed drakov">#drakov</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="https://blog.vietnamlab.vn/404/" title="#mock" class="tag tag-5e798cb6f7370d0001b812ae hash-mock">#mock</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="https://blog.vietnamlab.vn/404/" title="#test" class="tag tag-5e798cb6f7370d0001b812af hash-test">#test</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="https://blog.vietnamlab.vn/404/" title="#web" class="tag tag-5e813cddf7370d0001b812c5 hash-web">#web</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/10-meo-2/index.html" title="10 mẹo" class="tag tag-5ad30b8d837198000145843b 10-meo-2">10 mẹo</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/10-tips/index.html" title="10 tips" class="tag tag-5ad30b8d8371980001458432 10-tips">10 tips</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/2017/index.html" title="2017" class="tag tag-5ad30b8d8371980001458463 2017">2017</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/2018/index.html" title="2018" class="tag tag-5ad30b8d8371980001458464 2018">2018</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/2020/index.html" title="2020" class="tag tag-5e05cac4bf919d0001802e79 2020">2020</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/adaptive-threshold/index.html" title="adaptive threshold" class="tag tag-5ad30b8d8371980001458462 adaptive-threshold">adaptive threshold</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/adb/index.html" title="adb" class="tag tag-5d479f1fbf919d00018028c9 adb">adb</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/adsense/index.html" title="adsense" class="tag tag-5ad30b8d83719800014583a8 adsense">adsense</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/aff/index.html" title="aff" class="tag tag-5b6119898371980001458b0d aff">aff</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/agile/index.html" title="agile" class="tag tag-5ad30b8d837198000145834b agile">agile</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/ai/index.html" title="AI" class="tag tag-5ad30b8d8371980001458441 ai">AI</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/alert/index.html" title="alert" class="tag tag-5c2c443cc00d970001d2882a alert">alert</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/algorithm/index.html" title="Algorithm" class="tag tag-5e3bb937f7370d0001b8122e algorithm">Algorithm</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/android/index.html" title="android" class="tag tag-5ad30b8d837198000145834c android">android</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/android-studio/index.html" title="android studio" class="tag tag-5ad30b8d83719800014583ce android-studio">android studio</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/anguar-cli/index.html" title="anguar cli" class="tag tag-5ad30b8d837198000145834d anguar-cli">anguar cli</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/angular2/index.html" title="angular2" class="tag tag-5ad30b8d837198000145834e angular2">angular2</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/angular9/index.html" title="angular9" class="tag tag-5ea7b0b5f7370d0001b8132d angular9">angular9</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/ansible/index.html" title="Ansible" class="tag tag-5ad30b8d8371980001458450 ansible">Ansible</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/ant/index.html" title="ant" class="tag tag-5ad30b8d8371980001458398 ant">ant</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/apache/index.html" title="apache" class="tag tag-5ad30b8d837198000145834f apache">apache</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/apache-hive/index.html" title="Apache Hive" class="tag tag-5ad30b8d8371980001458351 apache-hive">Apache Hive</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/apache-knox/index.html" title="Apache Knox" class="tag tag-5ad30b8d8371980001458352 apache-knox">Apache Knox</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/apache-knox-gateway/index.html" title="Apache Knox Gateway" class="tag tag-5ad30b8d8371980001458353 apache-knox-gateway">Apache Knox Gateway</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/apache-poi/index.html" title="Apache POI" class="tag tag-5ad30b8d83719800014583d4 apache-poi">Apache POI</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/api/index.html" title="api" class="tag tag-5ad30b8d83719800014583c1 api">api</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/apiary-editor/index.html" title="apiary editor" class="tag tag-5ad30b8d83719800014583bf apiary-editor">apiary editor</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/application/index.html" title="application" class="tag tag-5bc99b038f5b6d0001832bfa application">application</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/ar/index.html" title="ar" class="tag tag-5ad30b8d8371980001458404 ar">ar</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/artoolkit/index.html" title="artoolkit" class="tag tag-5ad30b8d8371980001458405 artoolkit">artoolkit</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/aso/index.html" title="aso" class="tag tag-5b6119898371980001458b08 aso">aso</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/association-rules/index.html" title="Association Rules" class="tag tag-5ad30b8d83719800014583c5 association-rules">Association Rules</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/asynchronous/index.html" title="asynchronous" class="tag tag-5ad30b8d8371980001458355 asynchronous">asynchronous</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/atom/index.html" title="atom" class="tag tag-5ad30b8d83719800014583fd atom">atom</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/autoencoder/index.html" title="autoencoder" class="tag tag-5bfa780f165b57000125175c autoencoder">autoencoder</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/automation-testing/index.html" title="automation testing" class="tag tag-5ad30b8d83719800014583fe automation-testing">automation testing</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/awk/index.html" title="awk" class="tag tag-5ad30b8d8371980001458356 awk">awk</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/aws/index.html" title="AWS" class="tag tag-5ee65390f7370d0001b813e7 aws">AWS</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/aws-certified/index.html" title="AWS Certified" class="tag tag-5f262d1bf7370d0001b8146b aws-certified">AWS Certified</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/backend/index.html" title="backend" class="tag tag-5b30687483719800014589a0 backend">backend</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/backend2018/index.html" title="backend2018" class="tag tag-5b30687483719800014589a1 backend2018">backend2018</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/bao-cao/index.html" title="báo cáo" class="tag tag-5f9a48c4128d0900010f5c3f bao-cao">báo cáo</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/basictype/index.html" title="BasicType" class="tag tag-5ad30b8d83719800014583d9 basictype">BasicType</a>
                    </span>
                    <span class="label label-default text-justify tag">
                        <a href="../tag/bcrypt/index.html" title="bcrypt" class="tag tag-5d96a6f2bf919d0001802d24 bcrypt">bcrypt</a>
                    </span>
        </div>
    </div>
</div>
</div>
<div class="col-lg-offset-1"></div>


    </div>

    <div id="footer">
        <div class="row">
            <div class="col-lg-offset-1 col-lg-10 copyright">
                <a href="../index.html">GMO-Z.com Vietnam Lab Center Technology Blog</a> &copy; 2020
            </div>
            <div class="col-lg-offset-1"></div>
        </div>
    </div>

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-166653304-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-166653304-2');
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59342535-1', 'auto');
  ga('send', 'pageview');
</script>

<script>
MathJax = {
  tex: {
    inlineMath: [['\\(', '\\)']]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Libraries -->
    <script type="text/javascript" src="../assets/js/libs/jquery.fitvids.min.js?v=52156bd6b0"></script>
    <script type="text/javascript" src="../assets/js/libs/tocbot.min.js?v=52156bd6b0"></script>
    <script type="text/javascript" src="../assets/js/libs/bootstrap.min.js?v=52156bd6b0"></script>
    <script type="text/javascript" src="../assets/js/libs/highlight.pack.js?v=52156bd6b0"></script>

    <!-- Custom JS -->
    <script type="text/javascript" src="../assets/js/app/index.js?v=52156bd6b0"></script>

    <!-- App Services -->
    <script type="text/javascript" charset="UTF-8" src="https://cache.img.gmo.jp/common_header/script.js" async></script>
    <script src="https://apis.google.com/js/platform.js" async defer>{ lang: 'vi' }</script>

</body>

</html>