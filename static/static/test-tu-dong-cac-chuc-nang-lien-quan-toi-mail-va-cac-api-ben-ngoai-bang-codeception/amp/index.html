<!DOCTYPE html>
<html ⚡>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <title>Test các chức năng Mail và các API bên ngoài bằng Codeception</title>

    <meta name="description" content="Lần này mình sẽ giới thiệu về test tự động các chức năng lên kết với các service bên ngoài hoặc liên quan tới mail bằng cách sử dụng Coceception/PhantomJS" />
    <link rel="canonical" href="../index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="GMO-Z.com Vietnam Lab Center Technology Blog" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Test các chức năng Mail và các API bên ngoài bằng Codeception" />
    <meta property="og:description" content="Lần này mình sẽ giới thiệu về test tự động các chức năng lên kết với các service bên ngoài hoặc liên quan tới mail bằng cách sử dụng Coceception/PhantomJS" />
    <meta property="og:url" content="https://blog.vietnamlab.vn/test-tu-dong-cac-chuc-nang-lien-quan-toi-mail-va-cac-api-ben-ngoai-bang-codeception/" />
    <meta property="og:image" content="https://drive.google.com/uc?id&#x3D;0B05rqFCwNCjkbnY2TjBoU3o3Wkk&amp;export&#x3D;download" />
    <meta property="article:published_time" content="2017-09-05T10:47:00.000Z" />
    <meta property="article:modified_time" content="2017-09-06T00:44:15.000Z" />
    <meta property="article:tag" content="automation testing" />
    <meta property="article:tag" content="codeception" />
    
    <meta property="article:publisher" content="https://www.facebook.com/vietnamlab.vn" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Test các chức năng Mail và các API bên ngoài bằng Codeception" />
    <meta name="twitter:description" content="Lần này mình sẽ giới thiệu về test tự động các chức năng lên kết với các service bên ngoài hoặc liên quan tới mail bằng cách sử dụng Coceception/PhantomJS" />
    <meta name="twitter:url" content="https://blog.vietnamlab.vn/test-tu-dong-cac-chuc-nang-lien-quan-toi-mail-va-cac-api-ben-ngoai-bang-codeception/" />
    <meta name="twitter:image" content="https://drive.google.com/uc?id&#x3D;0B05rqFCwNCjkbnY2TjBoU3o3Wkk&amp;export&#x3D;download" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="P.T.G" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="automation testing, codeception" />
    <meta property="og:image:width" content="764" />
    <meta property="og:image:height" content="280" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "GMO-Z.com Vietnam Lab Center Technology Blog",
        "url": "https://blog.vietnamlab.vn/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://blog.vietnamlab.vn/favicon.ico",
            "width": 48,
            "height": 48
        }
    },
    "author": {
        "@type": "Person",
        "name": "P.T.G",
        "url": "https://blog.vietnamlab.vn/author/giangpt/",
        "sameAs": []
    },
    "headline": "Test các chức năng Mail và các API bên ngoài bằng Codeception",
    "url": "https://blog.vietnamlab.vn/test-tu-dong-cac-chuc-nang-lien-quan-toi-mail-va-cac-api-ben-ngoai-bang-codeception/",
    "datePublished": "2017-09-05T10:47:00.000Z",
    "dateModified": "2017-09-06T00:44:15.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://drive.google.com/uc?id=0B05rqFCwNCjkbnY2TjBoU3o3Wkk&export=download",
        "width": 764,
        "height": 280
    },
    "keywords": "automation testing, codeception",
    "description": "Ở bài trước mình đã giới thiệu qua về Codeception để viết test tự động , bạn nào\nchưa xem thì có thể tham khảo ở link bên dưới .\n\n  \nhttps://vietnamlab.vn/blog/2016/12/21/gioi-thieu-ve-codeception-framework-testing/\n[https://vietnamlab.vn/blog/2016/12/21/gioi-thieu-ve-codeception-framework-testing/]\n\nLần này mình sẽ giới thiệu về test tự động các chức năng lên kết với các service\nbên ngoài hoặc liên quan tới mail bằng cách sử dụng Codeception/PhantomJS . Với\nPhantomJS thì ta có thể test được các",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.vietnamlab.vn/"
    }
}
    </script>

    <meta name="generator" content="Ghost 3.36" />
    <link rel="alternate" type="application/rss+xml" title="GMO-Z.com Vietnam Lab Center Technology Blog" href="../../rss/index.html" />

    <style amp-custom>
    *,
    *::before,
    *::after {
        box-sizing: border-box;
    }

    html {
        overflow-x: hidden;
        overflow-y: scroll;
        font-size: 62.5%;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    body {
        min-height: 100vh;
        margin: 0;
        padding: 0;
        color: #3a4145;
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        font-size: 1.7rem;
        line-height: 1.55em;
        font-weight: 400;
        font-style: normal;
        background: #fff;
        scroll-behavior: smooth;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    p,
    ul,
    ol,
    li,
    dl,
    dd,
    hr,
    pre,
    form,
    table,
    video,
    figure,
    figcaption,
    blockquote {
        margin: 0;
        padding: 0;
    }

    ul[class],
    ol[class] {
        padding: 0;
        list-style: none;
    }

    img {
        display: block;
        max-width: 100%;
    }

    input,
    button,
    select,
    textarea {
        font: inherit;
        -webkit-appearance: none;
    }

    fieldset {
        margin: 0;
        padding: 0;
        border: 0;
    }

    label {
        display: block;
        font-size: 0.9em;
        font-weight: 700;
    }

    hr {
        position: relative;
        display: block;
        width: 100%;
        height: 1px;
        border: 0;
        border-top: 1px solid currentcolor;
        opacity: 0.1;
    }

    ::selection {
        text-shadow: none;
        background: #cbeafb;
    }

    mark {
        background-color: #fdffb6;
    }

    small {
        font-size: 80%;
    }

    sub,
    sup {
        position: relative;
        font-size: 75%;
        line-height: 0;
        vertical-align: baseline;
    }
    sup {
        top: -0.5em;
    }
    sub {
        bottom: -0.25em;
    }

    ul li + li {
        margin-top: 0.6em;
    }

    a {
        color: #1292EE;
        text-decoration-skip-ink: auto;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        margin: 0;
        font-weight: 700;
        color: #121212;
        line-height: 1.4em;
    }

    h1 {
        font-size: 3.4rem;
        line-height: 1.1em;
    }

    h2 {
        font-size: 2.4rem;
        line-height: 1.2em;
    }

    h3 {
        font-size: 1.8rem;
    }

    h4 {
        font-size: 1.7rem;
    }

    h5 {
        font-size: 1.6rem;
    }

    h6 {
        font-size: 1.6rem;
    }

    amp-img {
        height: 100%;
        width: 100%;
        max-width: 100%;
        max-height: 100%;
    }

    amp-img img {
        object-fit: cover;
    }

    .page-header {
        padding: 50px 5vmin 30px;
        text-align: center;
        font-size: 2rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .page-header a {
        color: #121212;
        font-weight: 700;
        text-decoration: none;
        font-size: 1.6rem;
        letter-spacing: -0.1px;
    }

    .post {
        max-width: 680px;
        margin: 0 auto;
    }

    .post-header {
        margin: 0 5vmin 5vmin;
        text-align: center;
    }

    .post-meta {
        margin: 1rem 0 0 0;
        text-transform: uppercase;
        color: #738a94;
        font-weight: 500;
        font-size: 1.3rem;
    }

    .post-image {
        margin: 0 0 5vmin;
    }

    .post-image img {
        display: block;
        width: 100%;
        height: auto;
    }

    .post-content {
        padding: 0 5vmin;
    }

    .post-content > * + * {
        margin-top: 1.5em;
    }

    .post-content [id]:not(:first-child) {
        margin: 2em 0 0;
    }

    .post-content > [id] + * {
        margin-top: 1rem;
    }

    .post-content [id] + .kg-card,
    .post-content blockquote + .kg-card {
        margin-top: 40px;
    }

    .post-content > ul,
    .post-content > ol,
    .post-content > dl {
        padding-left: 1.9em;
    }

    .post-content hr {
        margin-top: 40px;
    }

    .post .post-content hr + * {
        margin-top: 40px;
    }

    .post-content amp-img {
        background-color: #f8f8f8;
    }

    .post-content blockquote {
        position: relative;
        font-style: italic;
    }

    .post-content blockquote::before {
        content: "";
        position: absolute;
        left: -1.5em;
        top: 0;
        bottom: 0;
        width: 0.3rem;
        background: #000;
    }

    .post-content :not(.kg-card):not([id]) + .kg-card {
        margin-top: 40px;
    }

    .post-content .kg-card + :not(.kg-card) {
        margin-top: 40px;
    }

    .kg-card figcaption {
        padding: 1.5rem 1.5rem 0;
        text-align: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.4em;
        opacity: 0.6;
    }

    .kg-card figcaption strong {
        color: rgba(0,0,0,0.8);
    }

    .post-content :not(pre) code {
        vertical-align: middle;
        padding: 0.15em 0.4em 0.15em;
        border: #e1eaef 1px solid;
        font-weight: 400;
        font-size: 0.9em;
        line-height: 1em;
        color: #dc0050;
        background: #f0f6f9;
        border-radius: 0.25em;
    }

    .post-content > pre {
        overflow: scroll;
        padding: 16px 20px;
        color: #fff;
        background: #1F2428;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0,0,0,.1), 0 0 1px rgba(0,0,0,.4);
    }

    .kg-embed-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    .kg-image-card img {
        margin: auto;
    }

    .kg-gallery-card + .kg-gallery-card {
        margin-top: 0.75em;
    }

    .kg-gallery-container {
        position: relative;
    }

    .kg-gallery-row {
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    .kg-gallery-image {
        width: 100%;
        height: 100%;
    }

    .kg-gallery-row:not(:first-of-type) {
        margin: 0.75em 0 0 0;
    }

    .kg-gallery-image:not(:first-of-type) {
        margin: 0 0 0 0.75em;
    }

    .kg-bookmark-card,
    .kg-bookmark-publisher {
        position: relative;
    }

    .kg-bookmark-container,
    .kg-bookmark-container:hover {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row-reverse;
        color: currentColor;
        background: rgba(255,255,255,0.6);
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        text-decoration: none;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0, 0, 0, 0.1), 0 0 1px rgba(0, 0, 0, 0.4);
        overflow: hidden;
    }

    .kg-bookmark-content {
        flex-basis: 0;
        flex-grow: 999;
        padding: 20px;
        order: 1;
    }

    .kg-bookmark-title {
        font-weight: 600;
        font-size: 1.5rem;
        line-height: 1.3em;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        max-height: 45px;
        margin: 0.5em 0 0 0;
        font-size: 1.4rem;
        line-height: 1.55em;
        overflow: hidden;
        opacity: 0.8;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .kg-bookmark-metadata {
        margin-top: 20px;
    }

    .kg-bookmark-metadata {
        display: flex;
        align-items: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.3em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
    }

    .kg-bookmark-metadata amp-img {
        width: 18px;
        height: 18px;
        max-width: 18px;
        max-height: 18px;
        margin-right: 10px;
    }

    .kg-bookmark-thumbnail {
        display: flex;
        flex-basis: 20rem;
        flex-grow: 1;
        justify-content: flex-end;
    }

    .kg-bookmark-thumbnail amp-img {
        max-height: 200px;
    }

    .kg-bookmark-author {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .kg-bookmark-publisher::before {
        content: "•";
        margin: 0 .5em;
    }

    .kg-width-full.kg-card-hascaption {
        display: grid;
        grid-template-columns: inherit;
    }

    .post-content table {
        border-collapse: collapse;
        width: 100%;
    }

    .post-content th {
        padding: 0.5em 0.8em;
        text-align: left;
        font-size: .75em;
        text-transform: uppercase;
    }

    .post-content td {
        padding: 0.4em 0.7em;
    }

    .post-content tbody tr:nth-child(2n + 1) {
        background-color: rgba(0,0,0,0.1);
        padding: 1px;
    }

    .post-content tbody tr:nth-child(2n + 2) td:last-child {
        box-shadow:
            inset 1px 0 rgba(0,0,0,0.1),
            inset -1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:nth-child(2n + 2) td {
        box-shadow: inset 1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:last-child {
        border-bottom: 1px solid rgba(0,0,0,.1);
    }

    .page-footer {
        padding: 60px 5vmin;
        margin: 60px auto 0;
        text-align: center;
        background-color: #f8f8f8;
    }

    .page-footer h3 {
        margin: 0.5rem 0 0 0;
    }

    .page-footer p {
        max-width: 500px;
        margin: 1rem auto 1.5rem;
        font-size: 1.7rem;
        line-height: 1.5em;
        color: rgba(0,0,0,0.6)
    }

    .powered {
        display: inline-flex;
        align-items: center;
        margin: 30px 0 0;
        padding: 6px 9px 6px 6px;
        border: rgba(0,0,0,0.1) 1px solid;
        font-size: 12px;
        line-height: 12px;
        letter-spacing: -0.2px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        font-weight: 500;
        color: #222;
        text-decoration: none;
        background: #fff;
        border-radius: 6px;
    }

    .powered svg {
        height: 16px;
        width: 16px;
        margin: 0 6px 0 0;
    }

    @media (max-width: 600px) {
        body {
            font-size: 1.6rem;
        }
        h1 {
            font-size: 3rem;
        }

        h2 {
            font-size: 2.2rem;
        }
    }

    @media (max-width: 400px) {
        h1 {
            font-size: 2.6rem;
            line-height: 1.15em;
        }
        h2 {
            font-size: 2rem;
            line-height: 1.2em;
        }
        h3 {
            font-size: 1.7rem;
        }
    }
    </style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="page-header">
        <a href="../../index.html">
                GMO-Z.com Vietnam Lab Center Technology Blog
        </a>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">Test tự động các chức năng liên quan tới Mail và các API bên ngoài bằng Codeception</h1>
                <section class="post-meta">
                    P.T.G -
                    <time class="post-date" datetime="2017-09-05">05 Sep 2017</time>
                </section>
            </header>
            <figure class="post-image">
                <amp-img src="https://drive.google.com/uc?id&#x3D;0B05rqFCwNCjkbnY2TjBoU3o3Wkk&amp;export&#x3D;download" width="600" height="340" layout="responsive"></amp-img>
            </figure>
            <section class="post-content">

                <p>Ở bài trước mình đã giới thiệu qua về Codeception để viết test tự động , bạn nào chưa xem thì có thể tham khảo ở link bên dưới .</p>
<p><a href="https://vietnamlab.vn/blog/2016/12/21/gioi-thieu-ve-codeception-framework-testing/"> https://vietnamlab.vn/blog/2016/12/21/gioi-thieu-ve-codeception-framework-testing/ </a></p>
<p>Lần này mình sẽ giới thiệu về test tự động các chức năng lên kết với các service bên ngoài hoặc liên quan tới mail bằng cách sử dụng Codeception/PhantomJS . Với PhantomJS thì ta có thể test được các những trang có Javascript.(PhpBrowser thì không thể)</p>
<h3><strong>Xây dựng Codeception dựa trên nền Yii2 </strong></h3>
<h4><strong>Cấu hình của Yii2 </strong></h4>
<p>Project lấy Yii2 Advanced Framework làm cơ sở , bao gồm các module tiêu chuẩn frontend, backend, console, common. Lần này ta sẽ lấy frontend làm đối tượng để viết test, trong thư mục gốc của Project ta thiết lập 1 file codeception.yml như bên dưới. Trong mục include ta thiết lập module frontend, sau này nếu viết test cho các module khác thì ta có thể thêm vào tiếp theo.</p>
<p><em>codeception.yml</em></p>
<pre class="language-php"><code># global codeception file to run tests from all apps
include:
    - frontend
paths:
    log: logs
settings:
    colors: true</code></pre>
<p>Để sinh ra các test template ta chạy command phía dưới trong các thư mục của từng module.</p>
<pre class="language-php"><code>$ ../vendor/bin/codecept bootstrap</code></pre>
<p>Lần này để có thể test kiểm tra các response khi request tới các URL, ta chuẩn bị các file config ở trong các module (codeception.yml) và ở acceptance(acceptance.suite.yml). Thiết lập sao cho có thể sử dụng được thư viện HTTP client của Yii2 như  phía dưới .</p>
<p><em>frontend/codeception.yml</em></p>
<pre class="language-php"><code>namespace: frontend\tests  
actor: AcceptanceTester  
paths:  
    tests: tests
    log: tests/_output
    data: tests/_data
    helpers: tests/_support
settings:  
    bootstrap: _bootstrap.php
    colors: true
    memory_limit: 1024M
modules:  
    enabled:
        - Yii2:
            part: [httpclient]
            configFile: 'config/test.php'</code></pre>
<p>Frontend thì được test dựa trên browser nên ta sử dụng WebDriver để test . Các môi trường Staging và Product có URL khác nhau chính vì vậy ta phân tách từng môi trường riêng biệt ra . Ngoài ra ta cũng có thể thêm nhiều module khác nhau, ví dụ như thêm REST module sẽ cho phép bạn có thể test dựa trên HTTP.</p>
<p><em>frontend/tests/acceptance.suite.yml</em></p>
<pre class="language-php"><code>class_name: AcceptanceTester  
modules:  
    enabled:
        - WebDriver:
    config:
        WebDriver:
           browser: phantomjs
           host: '192.168.33.20'
           clear_cookies: true
           capabilities:
               phantomjs.page.settings.userAgent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36
<p>env:<br />
staging:<br />
modules:<br />
config:<br />
WebDriver:<br />
url: <a href="https://stg-gmo.example.com">https://stg-gmo.example.com</a></p>
<pre><code>prod:
    modules:
        config:
            WebDriver:
                url: https://gmo.example.com &lt;/code&gt;&lt;/pre&gt;
</code></pre>
<h4><strong>Chuyển đổi qua lại các môi trường test </strong></h4>
<p>Ta có thể chuyển đổi môi trường test khi chạy thông qua option --env , thông tin về các môi trường được thiết lập trong file frontend/tests/acceptance.suite.yml phía trên.</p>
<pre class="language-php"><code>vendor/bin/codecept run --env staging</code></pre>
<h4><strong>Chuẩn bị data test </strong></h4>
<p>Trong Codeception ta tạo ra các file dự liệu test và cung cấp cho từng test case , và cũng có thể tạo dữ liệu test tùy theo từng môi trường khác nhau.</p>
<p><em> frontend/tests/acceptance/data/common.yml</em></p>
<pre class="language-php"><code>staging:  
    user:
        user_id: 1000
        password: stagingpass
<p>prod:<br />
user:<br />
user_id: 2000<br />
password: prodpass</p></code></pre><p></p>
<p>Ví dụ về sử dụng dữ liệu test trong Codeception.</p>
<p><em>frontend/tests/acceptance/DataProviderExampleCest.php</em></p>
<pre class="language-php"><code>&lt;?php
<p>namespace frontend\tests\acceptance;</p>
<p>use Codeception\Example;<br />
use frontend\tests\AcceptanceTester;<br />
use Symfony\Component\Yaml\Yaml;</p>
<p>class DataProviderExampleCest<br />
{<br />
/**<br />
* @dataprovider _provider<br />
*/<br />
public function checkDataProviderExample(AcceptanceTester $I, Example $example)<br />
{<br />
$example['user']['user_id'];<br />
$example['user']['password'];<br />
}</p>
<pre><code>public function _provider()
{
    $common_data = Yaml::parse(file_get_contents(getcwd() . "/frontend/tests/acceptance/data/common.yml"));
    $env = getenv('env');

    return [$common_data[$env]];
}
</code></pre>
<p>}</p></code></pre><p></p>
<p>Chạy test theo từng môi trường.(staging)</p>
<pre class="language-php"><code>export env=staging;vendor/bin/codecept run --env $env</code></pre>
<h4><strong>Gmail API và cách sử dụng </strong></h4>
<p><a href="https://vietnamlab.vn/blog/2017/05/31/su-dung-google-gmail-api-de-thao-tac-voi-mail/">https://vietnamlab.vn/blog/2017/05/31/su-dung-google-gmail-api-de-thao-tac-voi-mail/ </a></p>
<p>Mình có viết 1 bài chi tiết về cách sử dụng Gmail API bạn nào chưa rõ thì có thể tham khảo.</p>
<p>Các bước cần chuẩn bị để sử dụng Gmail API</p>
<ul>
<li>Tạo Project từ Google API Console.</li>
<li>Chọn Project vừa được tạo.</li>
<li>Tạo OAuth Client ID từ trang API Manager.</li>
<li>Lấy Client ID và Client Secret.</li>
</ul>
<h3><strong>Test các chức nằng liên kết với các service bên ngoài. </strong></h3>
<p>Tôi sẽ giới thiệu về việc làm sao để test các chức năng mà có sử dụng các API bên ngoài. Ví dụ như viết test case cho chức năng liên quan tới Gmail Khi đăng ký 1 tài khoản mới . Thường ta phải vô mail để xác nhận việc đăng ký , với những chức năng như vậy để test được ta phải sử dụng Gmail API. </p>
<p><strong>Test case cho chức năng đăng ký thành viên mới có sử dụng Gmail API</strong></p>
<p><em>frontend\tests\RegistrationCest.php</em></p>
<pre class="language-php"><code>&lt;?php
<p>namespace frontend\tests\acceptance;</p>
<p>use Codeception\Example;<br />
use frontend\tests\AcceptanceTester;<br />
use frontend\tests\helpers\GmailAPIHelper;</p>
<p>class RegistrationCest extends BaseRegistrationCest<br />
{<br />
const WAIT_TIME_GMO_MAIL_SEND = 3;<br />
const REGEX_DETECT_REGISTRATION_URL = '#(<a href="https://w+">https://w+</a>)#';</p>
<pre><code>/**
 * @dataprovider _provider
 */
public function checkRegistration(AcceptanceTester $I, Example $example)
{
    $gmail = $example['gmail'];
    $member = $example['member'];

    $I-&amp;gt;wantTo('新規登録する');
    $I-&amp;gt;amOnPage('/');
    $I-&amp;gt;click('新規登録');

    $I-&amp;gt;fillField('email', $member['email']);
    $I-&amp;gt;click('次へ');
    // メールが受信されるまで待つ
    $I-&amp;gt;wait(self::WAIT_TIME_GMO_MAIL_SEND);

    $access_token = GmailAPIHelper::getAccessToken($gmail['client_id'], $gmail['client_secret'], $gmail['refresh_token']);
    $message_id = GmailAPIHelper::getLatestMessageId($access_token);
    $content = GmailAPIHelper::getMessageContent($message_id, $access_token);
    // メールの本文から登録URLを抽出する
    $registration_url = self::detectRegistrationUrl($content);

    $I-&amp;gt;amOnPage($registration_url);
    $I-&amp;gt;see('新規登録');
    $I-&amp;gt;fillField('password', $member['password']);
    $I-&amp;gt;fillField('password_confirm', $member['password']);
    $I-&amp;gt;click('同意して登録する');
}

private static function detectRegistrationUrl($content)
{
    preg_match(self::REGEX_DETECT_REGISTRATION_URL, $content, $m);

    return $m[1];
}
</code></pre>
<p>}</p></code></pre><p></p>
<p>Để có thể sử dụng được Gmail API ta phải lấy đươc access token , từ cái mail ID mới nhất ta lấy được nội dung mail. Tham khảo ở link phía trên để hiểu rõ hơn về Gmail API.</p>
<p><em>frontend\tests\helpers\GmailAPIHelper.php</em></p>
<pre class="language-php"><code>&lt;?php
<p>namespace frontend\tests\helpers;</p>
<p>use yii\httpclient\Client;</p>
<p>class GmailAPIHelper<br />
{<br />
const HTTP_HEADER_OAUTH2_AUTH_ACCESS_TOKEN = 'Authorization';</p>
<pre><code>const GOOGLE_API_URL_OAUTH2 = 'https://accounts.google.com/o/oauth2';
const GOOGLE_API_URL_OAUTH2_ISSUE_TOKEN = self::GOOGLE_API_URL_OAUTH2 . '/token';

const GOOGLE_API_SCOPE_GMAIL_READONLY = 'https://www.googleapis.com/auth/gmail.readonly';

const GOOGLE_API_OAUTH2_GRANT_TYPE_AUTHORIZATION_CODE = 'authorization_code';
const GOOGLE_API_OAUTH2_GRANT_TYPE_REFRESH_TOKEN = 'refresh_token';

const GMAIL_API_MESSAGES_URL = 'https://www.googleapis.com/gmail/v1/users/%s/messages/';
const GMAIL_API_MESSAGE_URL = 'https://www.googleapis.com/gmail/v1/users/%s/messages/%s';
const GMAIL_API_REDIRECT_URI = 'urn:ietf:wg:oauth:2.0:oob';

const GMAIL_TARGET_USER = 'me';
const GMAIL_MESSAGES_MAX_RESULTS = 1;

public static function getAccessToken($client_id, $client_secret, $refresh_token)
{
    $url = self::GOOGLE_API_URL_OAUTH2_ISSUE_TOKEN;
    $grant_type = self::GOOGLE_API_OAUTH2_GRANT_TYPE_REFRESH_TOKEN;
    $params = compact('client_id', 'client_secret', 'grant_type', 'refresh_token');
    $content = json_decode((new Client())-&amp;gt;post($url, $params)-&amp;gt;send()-&amp;gt;content, true);

    return $content['access_token'];
}

public static function getLatestMessageId($access_token)
{
    $url = sprintf(self::GMAIL_API_MESSAGES_URL, self::GMAIL_TARGET_USER);
    $maxResults = self::GMAIL_MESSAGES_MAX_RESULTS;
    $params = compact('maxResults');
    $headers = [self::HTTP_HEADER_OAUTH2_AUTH_ACCESS_TOKEN =&amp;gt; "Bearer {$access_token}"];

    $content = json_decode((new Client())-&amp;gt;get($url, $params, $headers)-&amp;gt;send()-&amp;gt;content, true);

    return $content['messages'][0]['id'];
}

public static function getMessageContent($message_id, $access_token)
{
    $url = sprintf(self::GMAIL_API_MESSAGE_URL, self::GMAIL_TARGET_USER, $message_id);
    $params = [];
    $headers = [self::HTTP_HEADER_OAUTH2_AUTH_ACCESS_TOKEN =&amp;gt; "Bearer {$access_token}"];

    $content = json_decode((new Client())-&amp;gt;get($url, $params, $headers)-&amp;gt;send()-&amp;gt;content, true);

    return base64_decode($content['payload']['body']['data']);
}
</code></pre>
<p>}</p></code></pre><p></p>
<p><strong>Test chức năng đăng nhập thông qua tài khoản Google account.</strong></p>
<p><em>frontend\tests\acceptance\social\google\LoginCest.php</em></p>
<pre class="language-php"><code>&lt;?php
<p>namespace frontend\tests\acceptance\social\google;</p>
<p>use Codeception\Example;<br />
use frontend\tests\AcceptanceTester;<br />
use frontend\tests\helpers\CleanUpHelper;<br />
use Symfony\Component\Yaml\Yaml;<br />
/**</p>
<ul>
<li>
<p>Googleログイン用のベースクラス<br />
*/<br />
abstract class LoginCest<br />
{<br />
const FIELD_NAME_GOOGLE_LOGIN_FORM= 'identifier';<br />
const FIELD_NAME_GOOGLE_PASSWORD_FORM = 'password';<br />
const FIELD_ID_GOOGLE_LOGIN_NEXT_BUTTON = 'identifierNext';<br />
const FIELD_ID_GOOGLE_PASSWORD_NEXT_BUTTON = 'passwordNext';</p>
<p>const WAIT_TIME_EMULATE_HUMAN_OPERATION = 1;</p>
<p>public function checkLogin(AcceptanceTester $I, Example $example)<br />
{<br />
$I-&gt;wantTo('Googleアカウントを使ってログインする');<br />
$I-&gt;amOnUrl("https://{$example['hosts']['gmo_id']}");<br />
$I-&gt;amOnPage('/');<br />
$I-&gt;click('ログイン');<br />
$I-&gt;click('Googleでログイン');<br />
$I-&gt;wait(self::WAIT_TIME_EMULATE_HUMAN_OPERATION);</p>
<pre><code> $I-&amp;gt;fillField(self::FIELD_NAME_GOOGLE_LOGIN_FORM, $example['member']['login']);
 $I-&amp;gt;wait(self::WAIT_TIME_EMULATE_HUMAN_OPERATION);

 $I-&amp;gt;click('#'.self::FIELD_ID_GOOGLE_LOGIN_NEXT_BUTTON);
 $I-&amp;gt;wait(5);

 $I-&amp;gt;waitForElement('#passwordNext', 5);
 $I-&amp;gt;fillField(self::FIELD_NAME_GOOGLE_PASSWORD_FORM, $example['member']['g-password']);
 $I-&amp;gt;wait(self::WAIT_TIME_EMULATE_HUMAN_OPERATION);

 $I-&amp;gt;click('#'.self::FIELD_ID_GOOGLE_PASSWORD_NEXT_BUTTON);
 $I-&amp;gt;wait(5);

 $I-&amp;gt;see('現在のポイント');
</code></pre>
<p>}</p>
<p>public function _provider()<br />
{<br />
$common_data = Yaml::parse(file_get_contents(getcwd() . "/frontend/tests/acceptance/data/common.yml"));<br />
$google_common_data = Yaml::parse(file_get_contents(getcwd() . "/frontend/tests/acceptance/data/social/google/common.yml"));<br />
$env = explode('-', getenv('env'))[0];</p>
<pre><code> return [array_merge($common_data[$env], $google_common_data[$env])];
</code></pre>
<p>}<br />
}<br />
</p></li></ul></code></pre><p></p>


<h3><strong>Kết  luận</strong></h3>
<p>Việc cài đặt thêm module PhantomJS giúp ta viết test được dễ dàng hơn rất nhiều với những trang có Javascript , tuy vẫn có những trường hợp không viết test được , nhưng phần lớn nó đã giúp ta tiết kiệm được khá nhiều thời gian trong việc test các ứng dụng.</p></code></pre>

            </section>

        </article>
    </main>
    <footer class="page-footer">
        <h3>GMO-Z.com Vietnam Lab Center Technology Blog</h3>
            <p>Blog chia sẻ kỹ thuật của thành viên công ty GMO-Z.com Vietnam Lab Center</p>
        <p><a href="../../index.html">Read more posts →</a></p>
        <a class="powered" href="https://ghost.org" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 156 156"><g fill="none" fill-rule="evenodd"><rect fill="#15212B" width="156" height="156" rx="27"/><g transform="translate(36 36)" fill="#F6F8FA"><path d="M0 71.007A4.004 4.004 0 014 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0130 84H4a4 4 0 01-4-4.007v-8.986zM50 71.007A4.004 4.004 0 0154 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0180 84H54a4 4 0 01-4-4.007v-8.986z"/><rect y="34" width="84" height="17" rx="4"/><path d="M0 4.007A4.007 4.007 0 014.007 0h41.986A4.003 4.003 0 0150 4.007v8.986A4.007 4.007 0 0145.993 17H4.007A4.003 4.003 0 010 12.993V4.007z"/><rect x="67" width="17" height="17" rx="4"/></g></g></svg> Published with Ghost</a>
    </footer>
    
</body>
</html>
